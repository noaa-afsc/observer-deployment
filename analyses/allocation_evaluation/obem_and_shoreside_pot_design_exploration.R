# TODO What rates would we need for OB + EM design?
# TODO How much more overlap do we get from the shoreside EM design?

library(data.table)         # Data wrangling
library(ggplot2)            # Plotting
library(sf)                 # Spatial analyses
library(dplyr)              # Data wrangling sf objects
library(flextable)          # Nicer tables in RMarkdown
library(officer)            # Better formatting of flextables
library(gridExtra)          # For combining plots and saving multiple figures to a single PDF

#======================================================================================================================#
# Data Prep ------------------------------------------------------------------------------------------------------------
#======================================================================================================================#

# Fishing effort data from 2018 to 2021
# `spatiotemporal_boxes.rdata' is generated by /analyses/spatiotemporal_boxes/data_prep.R

# TODO When testing is done, remove the line below!
load("analyses/allocation_evaluation/allocation_evaluation.RData")   # loads pc_effort_dt
val_2018_2022_dt <- pc_effort_dt[ADP %in% 2018:2022]

# Load the ADFG statistical area shapefile. '../' is needed for Rmarkdown to climb into parent folders.
stat_area_sf <- st_read(
  dsn = "source_data/ADFG_Stat_Area_shapefile/PVG_Statewide_2001_Present_GCS_WGS1984.shp", quiet = T) %>%
  select(STAT_AREA) %>%
  st_transform(crs = 3467)

# Load the Alaska map sf objects
load("source_data/ak_shp.rdata")      # shp_land, shp_nmfs, and shp_centroids added to global

#================#
## Trip Costs ----
#================#

# Use average values from the 2023 Final ADP for now. Also, roughly using trip_end - trip_start + 1 for now until we get
# a better handle on future monitoring costs.
ob_cpd <- 4896623 / 3094         # $1582.619/day
fgem_cpd <- 1e6 / (1040+735)     # $ 563.380/day
trwem_cpd <- 600                 # $600/day according to JF estimates used in set_budget.R in 2022 Final ADP repo
# Get average trip length for all strata, using TRIP_END - TRIP_START + 1
# This function counts number of unique days between each trip target date and landing date
# use this to count days for non-observed trips, which already have a modeled 'DAYS' estimate.
# day_count <- function(x) {
#   length(unique(unlist(apply(x, 1, function(y) as.numeric(as.Date(y[1])) : as.numeric(as.Date(y[2])), simplify = F))))
# }
# val_2018_2022_dt[POOL != "OB", DAYS := day_count(.SD), by = .(TRIP_ID), .SDcols = c("TRIP_TARGET_DATE", "LANDING_DATE")]
trip_cost_dt <- unique(val_2018_2022_dt[, .(ADP, STRATA, TRIP_ID, DAYS)])[, .(MEAN_TRIP_DAYS = mean(DAYS)), by = .(ADP, STRATA)]
# trip_cost_dt <- unique(val_2018_2022_dt[STRATA != "ZERO", .(ADP, STRATA, TRIP_ID, START, END)])[
# ][, .(MEAN_TRIP_DAYS = mean(as.numeric(END - START, units = "days") + 1)), by = .(ADP, STRATA)]
# Merge in day costs
trip_cost_dt[, CPD := fcase(
  STRATA == "EM_TRW", trwem_cpd,
  STRATA %in% c("EM_POT", "EM_HAL"), fgem_cpd,
  STRATA %in% c("OB_HAL", "OB_POT", "OB_TRW"), ob_cpd)]
# Calculate cost per trip
trip_cost_dt[, CPT := MEAN_TRIP_DAYS * CPD]
trip_cost_dt[STRATA == "ZERO", ':=' (CPD = 0, CPT = 0)]

#====================#
## Load Functions ----
#====================#

source("analyses/allocation_evaluation/functions.R")    

#======================================================================================================================#
# TODO GO DOWN TO 'STARTING OVER'
#======================================================================================================================#



#==========================#
## Apply Box Definition ----
#==========================#

# We'll be using 250km-wide hexagon cells as our spatial unit and 1-week bins. Neighbors are defined as trips in 
# adjacent spatial cells and in adjacent weeks.

# In terms of how we will evaluate the overlap between the observer pool with fixed-gear EM and zero, we will consider
# the gear types separately (i.e. post-stratify by GEAR). Additionally, we can include 'FMP' as a post-stratum so that
# we can quantify the overlap between the BSAI and GOA separately.
# 
# system.time(box_res <- define_boxes(
#   val_2018_2022_dt, c(2.5e5, 2.5e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
#   year_col = "ADP", stratum_cols = "STRATA", dmn_cols = c("BSAI_GOA", "GEAR"), geom = T))
# 
# system.time(box_res_fmp <- define_boxes(
#   val_2018_2022_dt, c(2.5e5, 2.5e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
#   year_col = "ADP", stratum_cols = c("STRATA", "BSAI_GOA"), dmn_cols = c("GEAR"), geom = T ))

#===================#
# OB + EM Design ####
#===================#

# TODO as an experiment, what level of observer coverage would be needed to improve the OB-EM and OB-ZE metrics?
# For this design, a subset of EM_HAL and EM_POT trips would be selected to carry an observer

# sample_rate_vec <- seq(from = 0.005, to = 0.95, by = 0.0001)
# 
# # First, get the metrics for proximity method (no observers on FG_EM trips)
# system.time(ispn_res <- calculate_interspersion(box_res, sample_rate_vec, omit_strata = "ZERO"))
# system.time(ispn_res_fmp <- calculate_interspersion(box_res_fmp, sample_rate_vec, omit_strata = "ZERO"))
# 
# # Now combine with trip costs and CV_scaling to determine the index afforded at a range of budgets and the allocated rates required
# system.time(index_res <- calculate_index(ispn_res, trip_cost_dt))
# system.time(index_res_fmp <- calculate_index(ispn_res_fmp, trip_cost_dt))
# 
# # Now, we have to assume a budget to see what rates were afforded
# budget_tbl <- data.table(INDEX_COST = 4.5e6)
# 
# group_cols <- unlist(index_res$params[c("year_col", "stratum_cols")], use.names = F)
# rates_4.5M <- index_res$rates[
# ][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols]
# 
# group_cols_fmp <- unlist(index_res_fmp$params[c("year_col", "stratum_cols")], use.names = F)
# rates_4.5M_fmp <- index_res_fmp$rates[
# ][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols_fmp]
# 
# #========================================================================================#
# ## What if we assumed that 1 in 4 FG_EM trips are selected to also carry an observer? ####
# #========================================================================================#
# 
# rates_4.5M    # Proximity method alone. Can also be used to assume 100% of EM trips also carry an observer
# rates_4.5M_1in2 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE * 0.5][] # 1 in 2
# rates_4.5M_1in4 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE * 0.25][] # 1 in 4
# rates_4.5M_1in8 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE * 0.125][] # 1 in 8
# 
# # TODO Have to account for the costs for having observers monitor these trips!
# # Could estimate using observer_sea_day_cost * trip_duration * em_ob_trip_rate (25% or 12.5%)?
# 
# rates_4.5M[ADP == 2022 & STRATA %like% ("HAL|POT")]  # With 1 in 4, EM_HAL around 5% and EM_POT around 8%
# rates_4.5M_1in2[ADP == 2022 & STRATA %like% ("HAL|POT")]  # With 1 in 4, EM_HAL around 5% and EM_POT around 8%
# rates_4.5M_1in4[ADP == 2022 & STRATA %like% ("HAL|POT")]  # With 1 in 4, EM_HAL around 5% and EM_POT around 8%
# rates_4.5M_1in8[ADP == 2022 & STRATA %like% ("HAL|POT")]  # With 1 in 4, EM_HAL around 5% and EM_POT around 8%
# 
# #========================================#
# ## Calculate Interspersion of Domains ####
# #========================================#
# 
# dmn_ispn_res <- calculate_dmn_interspersion(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT")))
# 
# # calculate_dmn_interspersion2 makes sure that when you specify a donor stratum it's not excluded as an 'acceptor' stratum
# dmn_ispn_res_1in1 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT", "ZERO")))
# 
# dmn_ispn_res_1in2 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M_1in2, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT", "ZERO")))
# 
# dmn_ispn_res_1in4 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M_1in4, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT", "ZERO")))
# 
# dmn_ispn_res_1in8 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M_1in8, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT", "ZERO")))
# 
# test2 <- rbind(
#   cbind(Method = "Prox",  dmn_ispn_res$dmn_ispn_dt),
#   cbind(Method = "OB+EM_1in1", dmn_ispn_res_1in1$dmn_ispn_dt),
#   cbind(Method = "OB+EM_1in2", dmn_ispn_res_1in2$dmn_ispn_dt),
#   cbind(Method = "OB+EM_1in4", dmn_ispn_res_1in4$dmn_ispn_dt),
#   cbind(Method = "OB+EM_1in8", dmn_ispn_res_1in8$dmn_ispn_dt)
# )[, Method := factor(Method, levels = c("Prox",  "OB+EM_1in8", "OB+EM_1in4", "OB+EM_1in2", "OB+EM_1in1"))]
# test2[, GROUP := fcase(STRATA %in% c("EM_HAL", "EM_POT"), "FG_EM", STRATA == "ZERO", "ZERO")]
# test3 <- test2[, .(DMN_ISPN = weighted.mean(DMN_ISPN, STRATA_DMN_N)), by = .(Method, ADP, GROUP, BSAI_GOA, GEAR)]
# 
# ggplot(test3[GEAR != "JIG"], aes(x = ADP, y = DMN_ISPN, fill = Method)) + 
#   facet_grid(GEAR ~ GROUP + BSAI_GOA) + geom_col(position = "dodge") + 
#   theme(legend.position = "bottom", axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
# # Putting observers on fixed-gear EM vessels does not improve interspersion except within the the BSAI fishing HAL gear.
# # ZERO x BSAI X HAL is largely doomed due to low overlap between FG_EM effort and ZERO effort
# box_res$dmn$strata_dmn_n_dt[ADP == 2022 & STRATA == "ZERO"]  # There were 127 ZERO-BSAI-HAL trips
# 
# # Plot fishing effort! Where is there not much overlap between OB, FG_EM, and ZERO in BSAI-HAL?
# # Plotting by week is a bit brutal
# ggplot() +
#   facet_grid(ADP + STRATA ~ TIME) +
#   geom_sf(
#     data = box_res$dmn$geom_dmn_df %>% filter(ADP == 2022 & GEAR == "HAL" & BSAI_GOA == "BSAI" & BOX_DMN_n > 0),
#     aes(fill = BOX_DMN_n)) +
#   scale_fill_viridis_c(trans = "sqrt") + theme(legend.position = "bottom")
# 
# # Spatially, ZERO has issues around Nome/St. Lawrence Island (6% effort) and around Egegik (1%). Although this is only 7% of 
# # effort, effort in the BSAI composed around 11% of effort, so the 50% domain interspersion makes sense.
# dmn_interspersion_plot(dmn_ispn_res, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_1in1, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# # FG_EM doesn't occur near Nome, so the only improvements granted from adding observers to EM boats are in the AI, not BS
# 
# # For FG_EM strata... also have issues in the BSAI, but not in the GOA
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_POT", "EM_HAL"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_1in8, strata = c("EM_POT", "EM_HAL"), gear = "HAL", year = 2022, type = "S", map = T)
# # So, is it better to put observers on FG_EM boats in the BSAI or to just increase OB coverage in the BSAI?
# rates_4.5M_1in8[ADP == 2022  & STRATA %like% "POT|HAL"] # Even 3-4% of trips with observers helps
# 
# # What if we added 3% monitoring to OB_HAL and OB_POT instead?
# add_3perc <- copy(rates_4.5M)[STRATA %in% c("OB_HAL", "OB_POT"), SAMPLE_RATE := SAMPLE_RATE + 0.03]
# dmn_ispn_res_add3 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = add_3perc, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT", "ZERO")))
# dmn_ispn_res_add3$dmn_ispn_dt[ADP == 2022 & BSAI_GOA == "BSAI" & STRATA %like% "EM_POT|EM_HAL"]
# dmn_ispn_res_1in8$dmn_ispn_dt[ADP == 2022 & BSAI_GOA == "BSAI" & STRATA %like% "EM_POT|EM_HAL"]
# dmn_ispn_res$dmn_ispn_dt[ADP == 2022 & BSAI_GOA == "BSAI" & STRATA %like% "EM_POT|EM_HAL"]
# 
# # this function takes domain interspersion and recalculates summaries with FG_EM grouped together
# group_fgem <- function(x) {
#   group_cols <- setdiff(unname(unlist(x$params)), "STRATA")
#   x1 <- copy(x$dmn_ispn_dt)
#   x1[, GROUP := ifelse(STRATA %in% c("EM_HAL", "EM_POT"), "FG_EM", STRATA)]
#   x1[, .(STRTA_DOMN_N = sum(STRATA_DMN_N), sum_DMN_pw = sum(sum_DMN_pw), DMN_ISPN = weighted.mean(DMN_ISPN, STRATA_DMN_N)), keyby = c("GROUP", group_cols)]
# }
# group_fgem(dmn_ispn_res)[ADP == 2022 & BSAI_GOA == "BSAI"]  # 76% interspersion for 31.3 trips, not great but small
# group_fgem(dmn_ispn_res_1in8)[ADP == 2022 & BSAI_GOA == "BSAI"]
# group_fgem(dmn_ispn_res_add3)[ADP == 2022 & BSAI_GOA == "BSAI"]
# 
# # Use the rates from stratifying by FMP
# dmn_ispn_res_fmp <- calculate_dmn_interspersion2(
#   box_res_fmp, selection_rates = rates_4.5M_fmp, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_HAL", "OB_POT", "OB_POT"), BSAI_GOA = c("BSAI", "GOA", "BSAI", "GOA")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_HAL", "EM_POT", "EM_POT", "ZERO", "ZERO"), BSAI_GOA = c("BSAI", "GOA", "BSAI", "GOA", "BSAI", "GOA")))
# 
# group_fgem(dmn_ispn_res)[ADP == 2022 & BSAI_GOA == "BSAI"]  # 76% interspersion for 31.3 trips, not great but small
# group_fgem(dmn_ispn_res_fmp)[ADP == 2022 & BSAI_GOA == "BSAI" & GEAR != "JIG"] # Stratifying by FMP helps a ton, even ZERO HAL is better!
# 
# rates_4.5M[ADP == 2022]; rates_4.5M_fmp[ADP == 2022]  
# # When stratifying by FMP, BSAI tends to get much higher ISPN values because of the impact of CV_SCALING is large.
# # That being said, ISPN is above 90% for all strata
# 
# unique(val_2018_2022_dt[STRATA == "OB_TRW" & BSAI_GOA == "BSAI"][, .(TRIP_ID, TARGET)])[, table(TARGET)] 
# # Almost all BSAI fishing is Cod (601 trips in 2022) - all of these will be in the PCTC starting in 2024!
# # Stratifying by FMP had us sampling 51 BSAI trips (5228.908 * 50 = $261K that can be allocated elsewhere)
# # TODO For OB_TRW and EM_TRW strata, stratifying by FMP doesn't seem to make much sense.
# # However, it does seem to make sense for OB_HAL and EM_POT strata to improve DMN_ISPN
# # TODO Do we need to stratify EM_POT and OB_POT by FMP though? Is it cheaper or more expensive, and for what gain?
# group_fgem(dmn_ispn_res)[ADP == 2022]
# group_fgem(dmn_ispn_res_fmp)[ADP == 2022 & GEAR != "JIG"]  # 
# 
# group_fgem(calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT"))))[ADP == 2022 & GEAR != "JIG"][order(GEAR, BSAI_GOA)]
# 
# # NOTE --- Why is the domain interspersion generally higher than the overall interspersion predicted in rates_4.5M?
# # I think it's because I get the addition of EM_POT trips that also fished HAL and vice versa (multi-gear trips)
# 
# rates_4.5M[ADP == 2022 & STRATA %in% c("EM_HAL" ,"EM_POT")] # 94.2 to 94.8 for both EM strata
# calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("EM_HAL", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("EM_HAL", "EM_POT")))$dmn_ispn_dt[ADP == 2022 & GEAR != "JIG"][order(STRATA, GEAR, BSAI_GOA)]
# 
# 
# 
# 
# 
# # If we had 100% observer, how would ZERO BSAI HAL look?
# rates_unreal <- copy(rates_4.5M)[STRATA %in% c("OB_HAL", "OB_POT"), SAMPLE_RATE := 1][] # 1 in 2
# dmn_ispn_res_unreal <- calculate_dmn_interspersion(
#   box_res, selection_rates = rates_unreal, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT")))
# dmn_interspersion_plot(dmn_ispn_res_unreal, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_ispn_res_unreal$dmn_ispn_dt[STRATA == "ZERO" & GEAR == "HAL" & BSAI_GOA == "BSAI"] # Theoretical max is 0.65 in BSAI, up to 0.78 in 2020
# 
# # And 100% observer on monitored FG EM as well?
# dmn_ispn_res_unreal2 <- calculate_dmn_interspersion(
#   box_res, selection_rates = rates_unreal, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT")))
# dmn_interspersion_plot(dmn_ispn_res_unreal2, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_ispn_res_unreal2$dmn_ispn_dt[STRATA == "ZERO" & GEAR == "HAL" & BSAI_GOA == "BSAI"] # Theoretical max is 0.65 in BSAI, up to 0.78 in 2020
# # Almost no improvement 
# 
# # Seems to be in start and end of year when there is ZERO effort but no OB effort
# # TODO Do we need more OB_HAL to overlap with ZERO x HAL?
# 
# 
# 
# 
# 
# 
# # Note that there are only around 31 fixed-gear EM trips fishing HAL in the BSAI! 
# box_res$dmn$strata_dmn_n_dt[ADP == 2022 & BSAI_GOA == "BSAI" & STRATA %like% "EM" & GEAR == "HAL"]  
# # There are over 100 OB pool HAL-gear trips in the BSAI, but overlap must be poor!
# box_res$dmn$strata_dmn_n_dt[ADP == 2022 & BSAI_GOA == "BSAI" & STRATA %like% "OB" & GEAR == "HAL"]  
# 
# 
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_1in8, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_1in4, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_1in1, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# 
# 
# 
# diff_tbl <- dcast(test2[GEAR != "JIG"], ADP + STRATA + BSAI_GOA + GEAR + STRATA_DMN_N ~ Method, value.var = "DMN_ISPN")
# diff_tbl[, DIFF := `OB+EM` - Allo]
# setkey(diff_tbl, GEAR, STRATA, ADP)
# diff_tbl
# 
# dmn_ispn_w_fmp <- dcast(
#   dmn_ispn_res$dmn_ispn_dt[
#   ][, .(GROUP = ifelse(STRATA %like% "EM", "EM", "ZERO")), by = .(ADP, STRATA, GEAR, BSAI_GOA, STRATA_DMN_N, sum_DMN_pw, DMN_ISPN)
#   ][, .(DMN_ISPN = weighted.mean(DMN_ISPN, w = STRATA_DMN_N, na.rm = T)), by = .(GEAR, GROUP, BSAI_GOA, ADP)],
#   GROUP + BSAI_GOA + GEAR ~ ADP, value.var = "DMN_ISPN")
# 
# # TODO I don't know what I was doing here
# dmn_ispn_w_fmp_test <- dcast(
#   dmn_ispn_res_test$dmn_ispn_dt[
#   ][, .(GROUP = ifelse(STRATA %like% "EM", "EM", "ZERO")), by = .(ADP, STRATA, GEAR, BSAI_GOA, STRATA_DMN_N, sum_DMN_pw, DMN_ISPN)
#   ][, .(DMN_ISPN = weighted.mean(DMN_ISPN, w = STRATA_DMN_N, na.rm = T)), by = .(GEAR, GROUP, BSAI_GOA, ADP)],
#   GROUP + BSAI_GOA + GEAR ~ ADP, value.var = "DMN_ISPN")
# 
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_test, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# 
# 
# 
# # Tabular form of FMP X BSAI X GEAR totals
# dmn_ispn_w_fmp
# dmn_ispn_w_fmp_test[GEAR != "JIG"]
# 
# 
# t1 <- cbind(Method =  "1.Prox", dmn_ispn_res$dmn_ispn_dt[
# ][, .(GROUP = ifelse(STRATA %like% "EM", "EM", "ZERO")), by = .(ADP, STRATA, GEAR, BSAI_GOA, STRATA_DMN_N, sum_DMN_pw, DMN_ISPN)
# ][, .(DMN_ISPN = weighted.mean(DMN_ISPN, w = STRATA_DMN_N, na.rm = T)), keyby = .(GEAR, GROUP, BSAI_GOA, ADP)])
# 
# t2 <- cbind(Method = "2.OB+EM", dmn_ispn_res_test$dmn_ispn_dt[
# ][, .(GROUP = ifelse(STRATA %like% "EM", "EM", "ZERO")), by = .(ADP, STRATA, GEAR, BSAI_GOA, STRATA_DMN_N, sum_DMN_pw, DMN_ISPN)
# ][, .(DMN_ISPN = weighted.mean(DMN_ISPN, w = STRATA_DMN_N, na.rm = T)), keyby = .(GEAR, GROUP, BSAI_GOA, ADP)][GEAR != "JIG"])
# 
# ggplot(rbind(t1,t2), aes(x = ADP, y = DMN_ISPN, fill = Method)) + facet_grid(GROUP ~ GEAR + BSAI_GOA) + geom_col(position = "dodge") + 
#   theme(legend.position = "bottom") + labs(x = "Year", y = "Domain Interspersion")
# 
# # with a OB+EM rate of 0.25...
# # p1 <- ggplot(rbind(t1,t2), aes(x = ADP, y = DMN_ISPN, fill = Method)) + facet_grid(GROUP ~ GEAR + BSAI_GOA) + geom_col(position = "dodge") + 
# #   theme(legend.position = "bottom") + labs(x = "Year", y = "Domain Interspersion")
# 
# # with a OB+EM rate of 0.125...
# # p2 <- ggplot(rbind(t1,t2), aes(x = ADP, y = DMN_ISPN, fill = Method)) + facet_grid(GROUP ~ GEAR + BSAI_GOA) + geom_col(position = "dodge") +
# #   theme(legend.position = "bottom") + labs(x = "Year", y = "Domain Interspersion")
# 
# # HAL-GOA interspersion for both EM and ZERO is already very high, so putting observers on those boats is not particularly useful!
# # It's HAL-BSAI where the most gains are seen with the EM Group
# p1
# p2
# 
# # TODO What are the theoretical maxima if we have observers on ALL trips selected for FG_EM monitoring?
# 
# 
# 
# 
# #====================================#
# # Shoreside observers with EM_POT ####
# #====================================#
# 
# # For now we assume that all EM_POT vessels have maximized retention and EM compliance monitoring on all trips and that 
# # a subset of offloads are monitored shoreside by observers for biological data collections.
# # Presumably the compliance monitoring would be cheaper than video review for counts and shoreside monitoring by observers
# # would be cheaper than at-sea observers (There would still be travel costs but monitoring for a day of an offload is cheaper 
# # than several days at sea)
# 
# # TODO need an assumed cost of shoreside + compliance EM for EM_POT in this design in order allocate.
# # For now, we'll just ignore costs to see the potential of improved overlap. Currently, overlap for pot gear vessels isn't 
# # really that bad and is mostly a function of how few trips actually fish there! 
# 
# # TODO Overall, interspersion values are pretty good in all strata except for 
# gear_smry <- copy(val_2018_2022_dt)[GEAR %in% c("POT", "HAL")][, GROUP := fcase(STRATA %like% "EM", "EM", STRATA %like% "OB", "OB", STRATA == "ZERO", "ZE")]
# dcast(gear_smry[, .(TRIP_N = uniqueN(TRIP_ID)), by = .(ADP, GROUP, GEAR, BSAI_GOA)], GEAR + GROUP + BSAI_GOA ~ ADP, fill = 0)
# # IN HAL_BSAI,  110 OB,  34 EM, and  128 ZERO (Overlap for ZERO here is consistently BAD since 2018)
# # IN HAL_GOA,  1348 OB, 736 EM, and 1404 ZERO (Overlap for EM here is 0.75 or lower, BAD)
# # IN POT_BSAI,  260 OB,  61 EM, and    7 ZERO (EM overlap is okay but declining over recent years, effort ~60 trips consistent). Zero effort is very LOW
# # IN POT_GOA,   951 OB, 348 EM, and   37 ZERO (Overlap is pretty good)
# 
# # In theory, shoreside POT EM could improve the overlap of BSAI-FGEM (ZERO-POT effort is very low!), but more importantly, it might be a more cost-effective
# # way to monitor this stratum
# 
# # TODO a heatmap of space and time with dmn_interspersion may be useful to fine spatiotemporal patterns of gaps/overlap
# # TODO A spatial map separated by month/quarter might be useful to see these patterns in both space and time and where gaps occur
# 
# test <- define_boxes_2(
#   val_2018_2022_dt, c(2.5e5, 2.5e5), time = c(30, 1), time_cols = c("TRIP_TARGET_DATE", "LANDING_DATE"),
#   year_col = "ADP", stratum_cols = "STRATA", dmn_cols = c("BSAI_GOA", "GEAR"), geom = T)
# 
# test_2022 <- test$geom_sf %>% filter(ADP == 2022 & !is.na(TIME))
# ggplot() + geom_sf(data = test_2022, aes(fill = BOX_n)) + facet_grid(STRATA ~ TIME) + 
#   # geom_sf_text(data = test_2022, aes(label = BOX_n)) + 
#   scale_fill_viridis_c(trans = "log") + 
#   theme(legend.position = "bottom")
# 
# # splitting further by gear type...
# test_2022_dmn <- test$dmn$geom_dmn_df %>% filter(ADP == 2022 & !is.na(TIME) & BOX_DMN_n > 0 )
# ggplot() + geom_sf(data = ak_low_res) + 
#   geom_sf(data = test_2022_dmn %>% filter(GEAR != "TRW"), aes(fill = BOX_DMN_n), alpha = 0.8) + facet_grid(STRATA + GEAR ~ TIME) + 
#   scale_fill_viridis_c(trans = "log", breaks = c(1, 10, 25, 50, 100)) + 
#   theme(legend.position = "bottom") 
# # TODO Making simpler geometry should speed up plotting considerably.
# 
# # Without map
# ggplot() +
#   geom_sf(data = test_2022_dmn %>% filter(GEAR != "TRW"), aes(fill = BOX_DMN_n), alpha = 0.8) + facet_grid(STRATA + GEAR ~ TIME) + 
#   scale_fill_viridis_c(trans = "log", breaks = c(1, 10, 25, 50, 100)) + 
#   theme(legend.position = "bottom") 
# # TODO Add component trip counts to DMN_ISPN figure
# 
# 
# #=======================================#
# # What is current status of overlap? ####
# #=======================================#
# 
# rates_4.5M[ADP == 2022]  # With $4.5M budget, OB_HAL at 12%, OB_POT at 13%
# 
# # dmn_ispn_res assumes 4.5M budget without stratifying by FMP, assuming donor as OB only.
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_HAL", "EM_POT"), gear = "HAL", year = 2022, type = "S", map = T)
# # No gaps in GOA, some in BS and large gaps for a few trips in the Aleutians
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_HAL", "EM_POT"), gear = "POT", year = 2022, type = "S", map = T)
# # Clearly some issues in the BS and AI for FG_EM POT
# 
# dmn_ispn_res$dmn_ispn_dt[STRATA == "ZERO" & ADP == 2022] # 
# dmn_interspersion_plot(dmn_ispn_res, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# # Small gaps around St. Lawrence Island. 127 trips in BSAI compared to 1401 in GOA
# dmn_interspersion_plot(dmn_ispn_res, strata = c("ZERO"), gear = "POT", year = 2022, type = "S", map = T)
# # Only 6.5 Trips in BSAI
# # TODO add total trip counts of acceptor strata to subtitle
# 
# 
# 
# 
# 
# #======================#
# # Would OB+EM help? ####
# #======================#
# 
# # TODO Would it help?
# # Might require further stratifying by FMP
# # If it helps, What would it cost? 
# # How would allocation work?
# 
# #=================================#
# # Would shoreside EM POT help? ####
# #=================================#
# 
# rates_4.5M[ADP == 2022] # ISPN for most strata above 94% in allocation stage.
# group_fgem(dmn_ispn_res)[ADP == 2022 & GEAR == "POT"] 
# # In 2022, FG_EM-BSAI is 87% with 58 trips. In GOA it's 95% with 300 trips.
# # ZERO POT effort is very low (only 42 trips in 2022). Would adding shoreside observers to EM_POT in the BSAI help?
# 
# dmn_interspersion_plot(dmn_ispn_res, strata = c("EM_HAL", "EM_POT"), gear = "POT", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res, strata = c("ZERO"), gear = "POT", year = 2022, type = "S", map = T)
# 
# shoreside_em <- calculate_dmn_interspersion2(box_res, rates_4.5M, donor_strata = data.table(STRATA = c("OB_POT", "EM_POT")), acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO", "OB_HAL", "OB_POT")))
# dmn_interspersion_plot(shoreside_em, strata = c("EM_HAL", "EM_POT"), gear = "POT", year = 2022, type = "S", map = T)
# group_fgem(shoreside_em)[ADP == 2022 & GEAR == "POT"]        # 98.3%. Might not need shoreside EM on every trip!
# 
# shoreside_em_rates_1in2 <- copy(rates_4.5M)[STRATA == "EM_POT", SAMPLE_RATE := SAMPLE_RATE / 2]
# shoreside_em_1in2 <- calculate_dmn_interspersion2(box_res, shoreside_em_rates_1in2, donor_strata = data.table(STRATA = c("OB_POT", "EM_POT")), acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO")))
# group_fgem(shoreside_em_1in2)[ADP == 2022 & GEAR == "POT"]   # 95.7% for FG_EM BSAI sampled at 13.1% shoreside
# 57.333 * 0.131  # Having 7.5 trips sampled on average would accomplish this. With compliance monitoring 
# 
# shoreside_em_rates_1in3 <- copy(rates_4.5M)[STRATA == "EM_POT", SAMPLE_RATE := SAMPLE_RATE / 3]
# shoreside_em_1in3 <- calculate_dmn_interspersion2(box_res, shoreside_em_rates_1in3, donor_strata = data.table(STRATA = c("OB_POT", "EM_POT")), acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO")))
# group_fgem(shoreside_em_1in3)[ADP == 2022 & GEAR == "POT"]   # 94.0% for FG_EM BSAI
# # Get's to be 94% here. Of 57 FG_EM POT trips, sampling 10% shoreside and the rest at sea for compliance would get overlap to 94%
# # Assuming we also have shoreside EM in the GOA, the additional biological data for shoreside observers would also improve ZERO-GOA from 88.9% to 97.3%
# 
# shoreside_em_rates_1in4 <- copy(rates_4.5M)[STRATA == "EM_POT", SAMPLE_RATE := SAMPLE_RATE / 4]
# shoreside_em_1in4 <- calculate_dmn_interspersion2(box_res, shoreside_em_rates_1in4, donor_strata = data.table(STRATA = c("OB_POT", "EM_POT")), acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO")))
# group_fgem(shoreside_em_1in4)[ADP == 2022 & GEAR == "POT"]   # 92.9% for FG_EM BSAI
# 
# # What if we stratified by FMP already? ####
# 
# group_fgem(dmn_ispn_res)[ADP == 2022 & GEAR == "POT"]  
# group_fgem(dmn_ispn_res_fmp)[ADP == 2022 & GEAR == "POT"]    # Everything already at around 95% or above, no issues?
# 
# group_fgem(dmn_ispn_res_fmp)[ADP == 2022 & GEAR != "JIG"]    # Only low value is with ZERO-BSAI, 127 trips with low overlap
# rates_4.5M_fmp[ADP == 2022 & STRATA %like% "OB"]             # That's even with 51% OB_HAL and 27% OB_POT in BSAI
# dmn_interspersion_plot(dmn_ispn_res_fmp, strata = c("ZERO"), gear = "HAL", year = 2022, type = "S", map = T)
# dmn_interspersion_plot(dmn_ispn_res_fmp, strata = c("ZERO"), gear = "HAL", year = 2022, type = "ST", map = T)
# # Spatiotemporal gaps around St Lawrence Island in mid-year (weeks 27-29, also weeks 38-39), some gaps in Aleutians too
# # in weeks 10-14
# 
# # TODO Can I group up weeks here? 4 at a time?
# 
# 
# # If stratifying by FMP
# dmn_ispn_res_fmp_all <- calculate_dmn_interspersion2(
#   box_res_fmp, rates_4.5M_fmp, 
#   donor_strata = data.table(STRATA = c("OB_POT", "OB_HAL", "OB_POT", "OB_HAL"), BSAI_GOA = c("BSAI", "BSAI", "GOA", "GOA")), 
#   acceptor_strata = data.table(STRATA = rep(c("EM_POT", "ZERO", "OB_HAL", "OB_POT"), times = 2), BSAI_GOA = rep(c("BSAI", "GOA"), each = 4)))
# a <- copy(dmn_ispn_res_fmp_all$dmn_ispn_geom)
# a_geom <- a %>% select(HEX_ID, geometry) %>% unique()
# a <- setDT(a %>% st_drop_geometry() %>% filter(GEAR == "POT")) 
# # TIME ranges from 1 to 50-53 for each ADP year
# a[, TIME_4 := cut(TIME, breaks = seq(0, 60, by = 4), include.lowest = T, labels = F)]
# a[, GROUP := fcase(STRATA %like% "EM", "FG_EM", STRATA %like% "OB", "OB", STRATA == "ZERO", "ZERO")]
# a_time_4 <- a[BOX_DMN_w > 0][, .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), BOX_SAMPLE_PROP = weighted.mean(BOX_SAMPLE_PROB, w = BOX_DMN_w, na.rm = T)), by = .(ADP, GROUP, BSAI_GOA, GEAR, TIME_4, HEX_ID)]
# a_time_4 <- merge(a_geom, a_time_4) 
# 
# ggplot() + 
#   facet_grid(GEAR + GROUP + BSAI_GOA ~ TIME_4) +  theme(legend.position = "bottom") + scale_fill_viridis_c() + 
#   geom_sf(data = a_time_4, aes(fill = BOX_SAMPLE_PROP)) # + geom_sf_text(data = a_time_4, )
# group_fgem(dmn_ispn_res_fmp)[ADP == 2022 & GEAR == "POT"]  # When stratifying by FMP, don't seem to have any issues
# 
# # And if we don't stratify by FMP but have shoreside EM?
# dmn_ispn_res_shoreside <- calculate_dmn_interspersion2(
#   box_res, rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_POT", "EM_POT")), 
#   acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO", "OB_HAL", "OB_POT")))
# a2 <- copy(dmn_ispn_res_shoreside$dmn_ispn_geom)
# a2_geom <- a2 %>% select(HEX_ID, geometry) %>% unique()
# a2 <- setDT(a2 %>% st_drop_geometry() %>% filter(GEAR == "POT")) 
# a2[, TIME_4 := cut(TIME, breaks = seq(0, 60, by = 4), include.lowest = T, labels = F)]
# a2[, GROUP := fcase(STRATA %like% "EM", "FG_EM", STRATA %like% "OB", "OB", STRATA == "ZERO", "ZERO")]
# a2_time_4 <- a2[BOX_DMN_w > 0][, .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), BOX_SAMPLE_PROP = weighted.mean(BOX_SAMPLE_PROB, w = BOX_DMN_w, na.rm = T)), by = .(ADP, GROUP, BSAI_GOA, GEAR, TIME_4, HEX_ID)]
# a2_time_4 <- merge(a2_geom, a2_time_4) 
# 
# ggplot() + 
#   facet_grid(GEAR + GROUP + BSAI_GOA ~ TIME_4) +  theme(legend.position = "bottom") + 
#   scale_fill_viridis_c() + 
#   geom_sf(data = a2_time_4, aes(fill = BOX_SAMPLE_PROP)) # + geom_sf_text(data = a_time_4, )
# 
# # With no shoreside EM, just prox without stratifying by FMP (baseline?)
# dmn_ispn_res_prox <- calculate_dmn_interspersion2(
#   box_res, rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_POT", "OB_HAL")), 
#   acceptor_strata = data.table(STRATA = c("EM_POT", "ZERO", "OB_HAL", "OB_POT")))
# a3 <- copy(dmn_ispn_res_prox$dmn_ispn_geom)
# a3_geom <- a3 %>% select(HEX_ID, geometry) %>% unique()
# a3 <- setDT(a3 %>% st_drop_geometry() %>% filter(GEAR == "POT")) 
# a3[, TIME_4 := cut(TIME, breaks = seq(0, 60, by = 4), include.lowest = T, labels = F)]
# a3[, GROUP := fcase(STRATA %like% "EM", "FG_EM", STRATA %like% "OB", "OB", STRATA == "ZERO", "ZERO")]
# a3_time_4 <- a3[BOX_DMN_w > 0][, .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), BOX_SAMPLE_PROP = weighted.mean(BOX_SAMPLE_PROB, w = BOX_DMN_w, na.rm = T)), by = .(ADP, GROUP, BSAI_GOA, GEAR, TIME_4, HEX_ID)]
# a3_time_4 <- merge(a3_geom, a3_time_4) 
# ggplot() + 
#   facet_grid(GEAR + GROUP + BSAI_GOA ~ TIME_4) +  theme(legend.position = "bottom") + 
#   scale_fill_viridis_c() + 
#   geom_sf(data = a3_time_4, aes(fill = BOX_SAMPLE_PROP))
# 
# # FIXME some trips obviously span the BSAI/GOA and some cells are clearly in the BSAI but show in the GOA panels
# group_fgem(dmn_ispn_res_prox )[ADP == 2022 & GEAR == "POT"]        # 0.88 in FG_EM BSAI, 0.89 in ZERO POT
# group_fgem(dmn_ispn_res_shoreside)[ADP == 2022 & GEAR == "POT"]    # 0.98 om FG_EM BSAI, 0.97 in ZERO POT
# group_fgem(dmn_ispn_res_fmp_all)[ADP == 2022 & GEAR == "POT"]      # 0.95 in FG_EM BSAI, 0.95 in ZERO POT 
# 
# # Plotting all months on top of eachother with transparency
# # The GOA cells look mostly fine, it's just the BSAI trips that extend into the GOA that look strange!
# ggplot() + 
#   facet_grid() +  theme(legend.position = "bottom") + 
#   geom_sf(data = ak_low_res) + 
#   facet_grid(BSAI_GOA ~ .) + 
#   scale_fill_viridis_c() + 
#   geom_sf(data = a3_time_4, aes(fill = BOX_SAMPLE_PROP), alpha = 0.5) + 
#   geom_sf(data = shp_nmfs, alpha = 0) 
# 
# # Having shoreside but only in the BSAI and on only half the trips might do the same thing?
# # TODO should we be labeling the HEX_IDs as either BSAI or GOA and only using BSAI_GOA as a stratum designator?
# 
# ggplot() + 
#   facet_grid() +  theme(legend.position = "bottom") + 
#   geom_sf(data = ak_low_res) + 
#   facet_grid(BSAI_GOA ~ .) + 
#   scale_fill_viridis_c() + 
#   geom_sf(data = a2_time_4, aes(fill = BOX_SAMPLE_PROP), alpha = 0.5) + 
#   geom_sf(data = shp_nmfs, alpha = 0) 
# 
# ggplot() + 
#   facet_grid() +  theme(legend.position = "bottom") + 
#   geom_sf(data = ak_low_res) + 
#   facet_grid(BSAI_GOA ~ .) + 
#   scale_fill_viridis_c() + 
#   geom_sf(data = a_time_4, aes(fill = BOX_SAMPLE_PROP), alpha = 0.5) + 
#   geom_sf(data = shp_nmfs, alpha = 0) 
# 
# 
# # TODO Would it help?
# # Might require further stratifying by FMP
# # If it helps, What would it cost? 
# # How would allocation work?


#======================================================================================================================#
# STARTING OVER --------------------------------------------------------------------------------------------------------
#======================================================================================================================#

# Define Box Definitions
# Will continue to use 200km spatial hex cells and 1-week temporal definition for boxes

# Box definition without stratifying by FMP
system.time(box_res <- define_boxes(
  val_2018_2022_dt, c(2e5, 2e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
  year_col = "ADP", stratum_cols = "STRATA", dmn_cols = c("BSAI_GOA", "GEAR"), geom = T))
# Box definition with FMP stratified, split by BSAI and GOA
system.time(box_res_fmp <- define_boxes(
  val_2018_2022_dt, c(2e5, 2e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
  year_col = "ADP", stratum_cols = c("STRATA", "BSAI_GOA"), dmn_cols = c("GEAR"), geom = T ))

# We have two proposed designs that intend to improve the degree of overlap of average weight/biological data with the
# fixed-gear EM and zero-coverage fleets. Before going into detail how those designs work, let's first establish the
# existing level of overlap under an example scenario. We'll use the 'Proximity' allocation scheme with a $4.5M budget
# and the existing stratification scheme (without FMP being split by BSAI vs GOA). To evaluate the overlap of biological 
# data for the FG-EM and zero-coverage pools, we will categorize fishing effort into domains that further subdivide our 
# boxes by gear type and FMP, which allows us to calculate the expected proportion of trips in a domain that will be 
# within or neighboring a sampled box with biological data (interspersion of biological data within a domain).
# Presumably, if new designs collect more biological data,  especially in domains where that data is not being
# collected, the domain interspersion will be higher.

sample_rate_vec <- seq(from = 0.005, to = 0.95, by = 0.0001)

# First, get the metrics for proximity method 
system.time(ispn_res <- calculate_interspersion(box_res, sample_rate_vec, omit_strata = "ZERO"))
system.time(index_res <- calculate_index(ispn_res, trip_cost_dt))
budget_tbl <- data.table(INDEX_COST = 4.5e6) # Now, we have to assume a budget to see what rates were afforded
group_cols <- unlist(index_res$params[c("year_col", "stratum_cols")], use.names = F)  # Extract grouping columns
rates_4.5M <- index_res$rates[
][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols]  # Allocated rates for proximity method

# Do the same when stratifying by FMP
system.time(ispn_res_fmp <- calculate_interspersion(box_res_fmp, sample_rate_vec, omit_strata = "ZERO"))
system.time(index_res_fmp <- calculate_index(ispn_res_fmp, trip_cost_dt))
group_cols <- unlist(index_res_fmp$params[c("year_col", "stratum_cols")], use.names = F)  # Extract grouping columns
rates_4.5M_fmp <- index_res_fmp$rates[
][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols]  # Allocated rates for proximity method

# Evaluate the proximity method, comparing to overlap of OB_HAL and OB_POT data to itself and dependent strata. 'box_res'
# was created with dmn_cols = c("BSAI_GOA", "GEAR") so that domains are boxes further subdivided by gear and FMP.

#======================================================================================================================#
## PROXIMITY -----------------------------------------------------------------------------------------------------------
#======================================================================================================================#

stratum_cols_og <- box_res$params$stratum_cols
stratum_dt_og <- unique(box_res$dmn$strata_dmn_n_dt[, ..stratum_cols_og])  #Get all stratum_cols in dataset
setorderv(stratum_dt_og, colnames(stratum_dt_og))
stratum_dt_og[, STRATUM_ID := .I]
acceptor_donor_lst_og <- c(
  rep(list(4:5), times = 2),                # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_og) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
dmn_insp_og <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_og)
# summary tables
dmn_insp_smry_og <- dmn_interspersion_smry(dmn_insp_og)
# summary plots
dmn_insp_plot_og <- dmn_interspersion_plot(dmn_insp_og, design_desc = "Prox")
dmn_insp_plot_og$PLOTS$HAL$`2022`

#======================================================================================================================#
## PROX STRATIFIED BY FMP ----------------------------------------------------------------------------------------------
#======================================================================================================================#

stratum_cols_fmp <- box_res_fmp$params$stratum_cols
stratum_dt_fmp <- unique(box_res_fmp$dmn$strata_dmn_n_dt[, ..stratum_cols_fmp])  #Get all stratum_cols in dataset
setorderv(stratum_dt_fmp, colnames(stratum_dt_fmp))
stratum_dt_fmp[, STRATUM_ID := .I]
acceptor_donor_lst_fmp <- c(
  rep(list(6:9), times = 4),                # EM_HAL.BSAI, EM_HAL.GOA, EM_POT.BSAI and EM_POT.GOA
  list(5),                                  # EM_TRW.BSAI
  rep(list(6:9), times = 4),                # OB_HAL.BSAI, OB_HAL.GOA, OB_POT.BSAI and OB_POT.GOA
  rep(list(10:11), times = 2),              # OB_TRW.BSAI and  OB_TRW.GOA
  rep(list(6:9), times = 2)                 # ZERO.BSAI and ZERO.GOA
)
names(acceptor_donor_lst_fmp) <- apply(stratum_dt_fmp[, ..stratum_cols_fmp], 1, function(x) paste0(x, collapse = "."))
dmn_insp_fmp <- calculate_dmn_interspersion3(box_res_fmp, rates_4.5M_fmp, stratum_dt_fmp, acceptor_donor_lst_fmp)
# summary tables
dmn_insp_smry_fmp <- dmn_interspersion_smry(dmn_insp_fmp)
# summary plots
dmn_insp_plot_fmp <- dmn_interspersion_plot(dmn_insp_fmp, design_desc = "Prox+FMP")
dmn_insp_plot_fmp$PLOTS$HAL$`2022`

#======================================================================================================================#
## SHORESIDE POT EM ----------------------------------------------------------------------------------------------------
#======================================================================================================================#

# If All EM_POT vessels also had all trips monitored shoreside for biologicals by observers
acceptor_donor_lst_spem <- c(
  rep(list(c(2,4,5)), times = 2),                # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_spem) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
dmn_insp_spem <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_spem)
# summary tables
dmn_insp_smry_spem <- dmn_interspersion_smry(dmn_insp_spem)
# summary plots
dmn_insp_plot_spem <- dmn_interspersion_plot(dmn_insp_spem, design_desc = "Shoreside Pot EM")
dmn_insp_plot_spem$PLOTS$HAL$`2022`

#======================================================================================================================#
## EM + OB -------------------------------------------------------------------------------------------------------------
#======================================================================================================================#

# what if we put Observers on all or a subset of FG_EM trips selected for monitoring?
acceptor_donor_lst_emob <- c(
  rep(list(c(1,2,4,5)), times = 2),         # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_emob) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
# If we assume all trips also take an observer...
dmn_insp_emob_1in1 <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in1 <- dmn_interspersion_smry(dmn_insp_emob_1in1)
dmn_insp_plot_emob_1in1 <- dmn_interspersion_plot(dmn_insp_emob_1in1, design_desc = "Shoreside Pot EM")
# or 1 in 2?
rates_emob_1in2 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 2]
dmn_insp_emob_1in2 <- calculate_dmn_interspersion3(box_res, rates_emob_1in2, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in2 <- dmn_interspersion_smry(dmn_insp_emob_1in2)
dmn_insp_plot_emob_1in2 <- dmn_interspersion_plot(dmn_insp_emob_1in2, design_desc = "Shoreside Pot EM")
# or 1 in 4
rates_emob_1in4 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 4]
dmn_insp_emob_1in4 <- calculate_dmn_interspersion3(box_res, rates_emob_1in4, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in4 <- dmn_interspersion_smry(dmn_insp_emob_1in4)
dmn_insp_plot_emob_1in4 <- dmn_interspersion_plot(dmn_insp_emob_1in4, design_desc = "Shoreside Pot EM")
# or 1 in 8
rates_emob_1in8 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 8]
dmn_insp_emob_1in8 <- calculate_dmn_interspersion3(box_res, rates_emob_1in8, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in8 <- dmn_interspersion_smry(dmn_insp_emob_1in8)
dmn_insp_plot_emob_1in8 <- dmn_interspersion_plot(dmn_insp_emob_1in8, design_desc = "Shoreside Pot EM")

# Save Outputs
if(F) {
  save(
    rates_4.5M, rates_4.5M_fmp, rates_emob_1in2, rates_emob_1in4, rates_emob_1in8,
    dmn_insp_smry_og, dmn_insp_smry_fmp, dmn_insp_smry_spem,
    dmn_insp_plot_og, dmn_insp_plot_fmp, dmn_insp_plot_spem,
    dmn_insp_smry_emob_1in1, dmn_insp_smry_emob_1in2, dmn_insp_smry_emob_1in4, dmn_insp_smry_emob_1in8,
    dmn_insp_plot_emob_1in1, dmn_insp_plot_emob_1in2, dmn_insp_plot_emob_1in4, dmn_insp_plot_emob_1in8,
    file = "analyses/allocation_evaluation/TEST_dmn_data.rdata"
  )
}


# # MOST OF WHAT IS BELOW IS HANDLED IN THE RMD
# # TODO Merge rates in here too!
# 
# test <- rbind(
#   cbind(Method = "Prox", dmn_insp_smry_og$OVERALL), 
#   cbind(Method = "Prox + FMP", dmn_insp_smry_fmp$OVERALL),
#   cbind(Method = "Shoreside EM_POT", dmn_insp_smry_spem$OVERALL),
#   cbind(Method = "EM+OB 1in1", dmn_insp_smry_emob_1in1$OVERALL),
#   cbind(Method = "EM+OB 1in4", dmn_insp_smry_emob_1in4$OVERALL)
# )
# test[, Method := factor(Method, levels = c("Prox", "Prox + FMP", "Shoreside EM_POT", "EM+OB 1in1", "EM+OB 1in4"))]
# 
# ggplot(test[ADP == 2022 & GEAR %in% c("HAL", "POT")], aes(x = Method, y= POOL_DMN_INTERSPERSION)) + 
#   geom_col() + facet_grid(POOL ~ GEAR) + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust= 0.5))
# 
# test_fmp <- rbind(
#   cbind(Method = "Prox", dmn_insp_smry_og$BSAI_GOA), 
#   cbind(Method = "Prox + FMP", dmn_insp_smry_fmp$BSAI_GOA),
#   cbind(Method = "Shoreside EM_POT", dmn_insp_smry_spem$BSAI_GOA),
#   cbind(Method = "EM+OB 1in1", dmn_insp_smry_emob_1in1$BSAI_GOA),
#   cbind(Method = "EM+OB 1in4", dmn_insp_smry_emob_1in4$BSAI_GOA)
# )
# test_fmp[, Method := factor(Method, levels = c("Prox", "Prox + FMP", "Shoreside EM_POT", "EM+OB 1in1", "EM+OB 1in4"))]
# ggplot(test_fmp[ADP == 2022 & GEAR %in% c("HAL", "POT")], aes(x = Method, y= POOL_DMN_INTERSPERSION)) + 
#   geom_col() + facet_grid(POOL ~ GEAR + BSAI_GOA) + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust= 0.5)) + 
#   geom_text(aes(label = round(BOX_DMN_w, 0)), size = 2, nudge_y = -0.05, color = "white")
# 
# # TODO NOTE that the way that the hex cells are colored stresses the ability to fill cells, and are not weighted by the 
# # number of trips in each cell.
# 
# ggplot(test_fmp[ADP == 2021 & GEAR %in% c("HAL", "POT")], aes(x = Method, y= POOL_DMN_INTERSPERSION)) + 
#   geom_col() + facet_grid(POOL ~ GEAR + BSAI_GOA) + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust= 0.5)) + 
#   geom_text(aes(label = round(BOX_DMN_w, 0)), size = 2, nudge_y = -0.05, color = "white")
# 
# 
# dmn_insp_smry_og$BSAI_GOA[ADP == 2022 & GEAR %in% c("HAL", "POT")]
# 
# 
# 
# # POT GEAR
# ggsave(
#   filename = "analyses/allocation_evaluation/figures/TEST_dmm_hal_2022.pdf", 
#   plot = marrangeGrob(list(
#     dmn_insp_plot_og$PLOTS$HAL$`2022`, dmn_insp_plot_fmp$PLOTS$HAL$`2022`, dmn_insp_plot_spem$PLOTS$HAL$`2022` 
#     ), nrow=1, ncol=1), 
#   width = 8.5, height = 11
# )
# 
# 
# dmn_insp_smry_og$BSAI_GOA[ADP == 2022 & GEAR == "POT"]     # POT BSAI is a bit lower at 0.876
# dmn_insp_smry_fmp$BSAI_GOA[ADP == 2022 & GEAR == "POT"]
# dmn_insp_smry_spem$BSAI_GOA[ADP == 2022 & GEAR == "POT"]
# 
# # HAL GEAR
# ggsave(
#   filename = "analyses/allocation_evaluation/figures/TEST_dmm_pot_2022.pdf", 
#   plot = marrangeGrob(list(
#     dmn_insp_plot_og$PLOTS$POT$`2022`, dmn_insp_plot_fmp$PLOTS$POT$`2022`, dmn_insp_plot_spem$PLOTS$POT$`2022` 
#   ), nrow=1, ncol=1), 
#   width = 8.5, height = 11
# )  
# 
# # TODO So if we were to use POOL_DMN_INTERSPERSION to and multiply it with the index (CV+SCALING + INTERSPERSION), could
# # we allocate that way? It might be too harsh, unless we scale it against its theoretical maximum?
# # It would also depend on whether we want to weight with or without splitting BSAI vs GOA?
# # Shoreside POT_EM, at this rate, we'd have:
# dmn_insp_smry_og$OVERALL[ADP == 2022 & GEAR == "POT"]    # 0.9313048
# dmn_insp_smry_og$BSAI_GOA[ADP == 2022 & GEAR == "POT" & POOL == "EM"]   # 0.877 and 0.946
# rates_4.5M[ADP == 2022 & STRATA == "EM_POT"] # 0.9426442 / 0.07576055 = INDEX of 12.44156, 
# # It's already being sampled at 0.3178...
# # TODO Instead of multiplying INDEX by DMN_ISPN for EM_POT, what if we wanted to Instead get the 0.9313 to match as closely
# # to OB's 0.966?
# 
# 
# dmn_insp_smry_spem$OVERALL[ADP == 2022 & GEAR == "POT"]  # 0.9941024  # with 1in1 sampled shoreside
# dmn_insp_smry_spem$BSAI_GOA[ADP == 2022 & GEAR == "POT" & POOL == "EM"]  # 0.979 and 0.998, a little overkill?
# 
# dmn_insp_smry_fmp$OVERALL[ADP == 2022 & GEAR == "POT"]   # 0.9487354
# dmn_insp_smry_fmp$BSAI_GOA[ADP == 2022 & GEAR == "POT" & POOL == "EM"]  # 0.949 and 0.949
# 
# 
# rates_4.5M[ADP == 2022 & STRATA == "EM_POT"]  # 0.9426442 * 0.07576055 * 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# #=============================#
# 
# # OLD VERSION ####
# dmn_ispn_res <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT")),
#   acceptor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT", "ZERO")))
# 
# # For now, we will keep our example focused on 2022 fishing effort.
# rates_4.5M[ADP == 2022]   # There are results of the allocation (STRATA_N and sample rates)
# dmn_ispn_res$dmn_ispn_dt[ADP == 2022 & GEAR != "JIG"]
# dmn_ispn_res$params
# 
# 
# 
# BELOW IS OLD ####
# 
# # This function summarizes outputs of calculate_dmn_interspersion2 so that interspersion of pools is combined as a 
# # weighted average.
# group_pools <- function(x) {
#   pool_cols <- c(x$params$year_col, x$params$dmn_cols)
#   x1 <- copy(x$dmn_ispn_dt)
#   x1[, GROUP := fcase(STRATA %like% "EM", "EM", STRATA %like% "OB", "OB", STRATA %like% "ZERO", "ZERO")]
#   x1[, GROUP := factor(GROUP, levels = c("OB", "EM", "ZERO"))]
#   x1[, .(DMN_N = sum(STRATA_DMN_N, na.rm = T), DMN_ISPN = weighted.mean(DMN_ISPN, w = STRATA_DMN_N)), keyby = c("GROUP", pool_cols)]
# }
# dmn_ispn_res_pool <- group_pools(dmn_ispn_res)
# 
# # For reference, the stratum-level interspersion afforded by the $4.5M budget was 0.93 or above, most around 0.945
# dmn_ispn_res_pool[ADP == 2022 & GEAR =="HAL"]
# # HAL-BSAI : Biological overlap for OB (104 trips) = 0.75, EM (31 trips) = 0.76, ZE (127 trips) = 0.342. GOA looks fine
# dmn_ispn_res_pool[ADP == 2022 & GEAR =="POT"]
# # POT-BSAI: Biological overlap for EM (58 trips) = 0.876
# # POT-GOA : Biological overlap for ZERO (35 trips) = 0.89
# 
# # So as far as overlap goes, the HAL overlap could definitely improve in the BSAI region for all pools (OB, EM, and ZE).
# # For POT, it varies: FG_EM could improve in the BSAI and ZERO could improve in the GOA, but the number of trips that 
# # fish there are relatively small.
# 
# # TODO Look at tonnage of the BSAI trips to see if any are large?
# 
# # Let's look at where in space and time where lack of overlap exists. We'll group up every 4 weeks of data together to 
# # help with plotting the spatiotemporal arrangement of fishing effort.
# 
# # This function groups up 
# four_week <- function(x) {
#   # x <- copy(dmn_ispn_res)
#   
#   dmn_cols <- unname(unlist(copy(x$params)))
#   geom_dat <- copy(x$dmn_ispn_geom) %>% select(HEX_ID, geometry) %>% unique()   # Isolate the geometry data
#   
#   # Group up weeks into 4-week blocks and summarize. Sample probability is now a weighted average of the sample probabilities,
#   # weighted by the number of component trips in each week.
#   x1 <- x$dmn_ispn_geom %>% st_drop_geometry() %>% setDT()
#   x1[, TIME_4 := cut(TIME, breaks = seq(min(TIME), max(TIME), by = 4), include.lowest = T, labels = F)]
#   x1[BOX_DMN_w > 0, .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), SAMPLE_PROB = weighted.mean(BOX_SAMPLE_PROB, w = BOX_DMN_w)), by = c(dmn_cols, "HEX_ID", "TIME_4")]
#   
#   # Now combine pools (ignore strata, use POOL instead)
#   pool_cols <- c("POOL", setdiff(dmn_cols, "STRATA"))
#   x1[, POOL := fcase(STRATA %like% "OB", "OB", STRATA %like% "EM", "EM", STRATA %like% "ZERO", "ZERO")]
#   x1[, POOL := factor(POOL, levels = c("OB", "EM", "ZERO"))]
#   x1 <- x1[BOX_DMN_w > 0 , .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), SAMPLE_PROB = weighted.mean(BOX_SAMPLE_PROB, w = BOX_DMN_w)), by = c(pool_cols, "HEX_ID", "TIME_4") ]
#   
#   # Merge geometry data back in
#   x1 <- merge(geom_dat, x1, by = "HEX_ID")
#   x1
# }
# 
# dmn_ispn_res_4wk <- four_week(dmn_ispn_res)
# 
# # For each time period, identify cells where donor data exists!
# 
# plot_4_week <- function(x, donors, year_subset) {
#   # x <- copy(dmn_ispn_res_4wk); donors <- data.table(POOL = c("OB")); year_subset <- 2022
#   # x <- copy(dmn_ispn_res_4wk_shoresidepotem); data.table(POOL = c("OB", "OB", "EM"), GEAR = c("HAL", "POT", "POT")); year_subset <- 2022
#   
#   geom_dat <- x %>% select(HEX_ID, geometry) %>% unique()
#   x1 <- x %>% st_drop_geometry() %>% filter(GEAR != "JIG") %>% setDT()  
#   donor_boxes <- unique(x1[donors, on = colnames(donors)][, .(ADP, GEAR, HEX_ID, TIME_4)])
#   
#   # For the sake of plotting, ignore BSAI_GOA here and summarize on TIME and HEX_ID. Some trips that spanned FMPs have
#   # HEX_IDs that are geographically in the wrong FMP
#   x1 <- x1[, .(BOX_DMN_w = sum(BOX_DMN_w, na.rm = T), SAMPLE_PROB = weighted.mean(SAMPLE_PROB, w = BOX_DMN_w)) , by = .(GEAR, POOL, ADP, HEX_ID, TIME_4)]
#   x1_subset <- x1 %>% filter(ADP == year_subset & GEAR != "JIG")
# 
#   # Identify cells where acceptor trips exist but no donor trips exist
#   no_donors <- setdiff(x1_subset,  merge(x1_subset, donor_boxes))
# 
#   # Merge geometry data back in
#   x1_subset <- merge(geom_dat, x1_subset)
#   donor_boxes <- merge(geom_dat, donor_boxes)
#   no_donors <- merge(geom_dat, no_donors)
#   
#   donor_labels <- paste(apply(donors, 1, paste, sep = "-"), collapse = " + ")
#   
#   # having Time on the y-axis fits a little better because the maps are wider than they are tall.
#   plot_out <- ggplot() + 
#     facet_grid(TIME_4 ~ GEAR + POOL) + 
#     geom_sf(data = x1_subset, aes(fill = SAMPLE_PROB)) + 
#     theme(legend.position = "bottom") + 
#     geom_sf(data = donor_boxes, alpha = 0) + # Boxes where donor data exists
#     geom_sf(data = no_donors, color = "red", alpha = 0, lwd = 0.8) +
#     scale_fill_viridis_c(breaks = seq(0, 1, by = 0.2)) +
#     labs(fill = "Probability sampled")
#   # Note that the highlighted red cells are where a 'donor' stratum (e.g., OB-HAL and OB-POT) including at least one trip
#   # in the spatial cell x 4-week period. In the HAL gear facets, it includes any trip in the OB-HAL or OB-POT stratum that 
#   # fished with HAL gear.
#   # Any cells outlined in red mean that increasing sample rate of donor strata likely won't improve overlap
#   # Those highlighted cells mean no donor trips occurred in box within that 4-week span (but could still be in neighboring cells)
#   
#   list(
#     caption = noquote(paste0(
#       year_subset, " fishing effort divided into 250km hex cells and 4-week blocks, with ", donor_labels, 
#       " as data donors. Cells containing at least one donor trip are outlined in black, those without are outlined in red. Cell fill color represents the probability that the cell will contain at least one sampled donor trip."
#     )),
#     plot = plot_out
#   )
#   
# }
# 
# # TODO Note that some cells might be overlapping because the BSAI_GOA column is part of stratum, not CELL!
# # That is, if a trips crossed strata but mostly fished in the GOA, it will still have HEX_IDs in the BSAI...
# 
# plot_4_week(dmn_ispn_res_4wk, donors = data.table(POOL = "OB"), year_subset = 2022)
# # Here we can interpret any areas with non-yellow cells as being at risk of being without OB data. We can also interpret
# # the cells in red as being 4-week and 250km-wide cells where no OB-fishing fishing occurs (but may occur in neighboring cells)
# # For HAL gear, we see that the OB data is more scarce in the BSAI and that this translates into lower sample probabilities
# # in the EM and ZERO pools. 
# 
# # TODO There doesn't seem to be many cases where FG-EM overlaps ZERO where OB does not, but it would 'supplement' where OB
# # already exists but may not be sampled within OB reliably. 
# 
# #================================#
# # Proposed Deployment Designs ####
# #================================#
# 
# # The EM+OB design intends to additionally place at-sea observers on fixed-gear 
# # EM vessels on a subset of trips selected for EM monitoring. The Shoreside EM POT design would have all EM-POT vessels 
# # monitored for compliance 100% of the time with maximized retention, a subset of trips selected for at-sea EM
# # monitoring for counts, and have a subset of offloads monitored by observers shoreside for species composition and 
# # biological data. 
# 
# #=====================#
# # Shoreside POT EM ####
# #=====================#
# 
# # For now, assume all selected EM_POT trips are also sampled by observers shoreside (1in1)
# 
# # FIXME would the shoreside POT EM stratum allow these vessels to also fish HAL gear? The average weight data wouldn't be
# # able to tell what gear type was used for which fish.
#  
# dmn_ispn_res_shoresidepotem <- calculate_dmn_interspersion2(
#   box_res, selection_rates = rates_4.5M, 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT", "ZERO")))
# 
# # with calculate_dmn_interspersion2, Make 'donor' and acceptor strata a single table that includes only what you want to compare!
# 
# # default, with OB strata as the only donors
# data.table(
#   DONOR = c(rep("OB_HAL", times = 5), rep("OB_POT", times = 5)),
#   ACCEPTOR = rep(c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT", "ZERO"), times = 2)
# )
# 
# 
# 
# 
# 
# 
# 
# 
# # DONOR = c(rep("OB_HAL", times = 5), rep("OB_POT", times = 5), "EM_POT")
# # ACCEPTOR = c(rep(c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT", "ZERO"), times = 2), "EM_POT")
# 
# 
# 
# 
# dmn_ispn_res_pool_shoresidepotem <- group_pools(dmn_ispn_res_shoresidepotem)
# dmn_ispn_res_4wk_shoresidepotem <- four_week(dmn_ispn_res_shoresidepotem)
# plot_4_week(dmn_ispn_res_4wk_shoresidepotem, donors = data.table(POOL = c("OB", "OB", "EM"), GEAR = c("HAL", "POT", "POT")), year_subset = 2022)
# # TODO NEED TO FIX DONORS - needs to identify it from calculate_dmnn_interspersion2?
# 
# dmn_ispn_res_pool_shoresidepotem[ADP == 2022 & GEAR =="HAL"]
# dmn_ispn_res_pool_shoresidepotem[ADP == 2022 & GEAR =="POT"]
# # Clearly, having EVERY EM-POT trip monitored shoreside results in very high domain interspersion, including for ZERO-GOA-POT
# # However, as would be expected, it has minimal impact on the HAL gear domains. Here, out of laziness, we assume that all EM_POT
# # trips were monitored shoreside, even if they fished HAL gear too, which may not necessarily be the case if implemented?
# 
# # If we had only half of the POT-EM trips monitored shoreside, what would we get?
# shoreside_rates_1in2 <- copy(rates_4.5M)[STRATA == "OB_POT", SAMPLE_RATE := SAMPLE_RATE / 2]
# dmn_ispn_res_shoresidepotem2 <- calculate_dmn_interspersion2(
#   box_res, selection_rates = shoreside_rates_1in2 , 
#   donor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_POT")),
#   acceptor_strata = data.table(STRATA = c("OB_HAL", "OB_POT", "EM_HAL", "EM_POT", "ZERO")))
# dmn_ispn_res_pool_shoresidepotem2 <- group_pools(dmn_ispn_res_shoresidepotem2)
# dmn_ispn_res_4wk_shoresidepotem2 <- four_week(dmn_ispn_res_shoresidepotem2)
# plot_4_week(dmn_ispn_res_4wk_shoresidepotem2, donors = data.table(POOL = c("OB", "OB", "EM"), GEAR = c("HAL", "POT", "POT")), year_subset = 2022)
# 
# # FIXME NEED TO FIX DONORS - needs to identify it from calculate_dmnn_interspersion2?
# # TODO output the donor and acceptor strata from calculate_interspersion2
# # TODO Can I have that function make a geometry that contains only donor strata cells? or do this when using group_pools?
# 
# # FIXME - right now the functions are assuming that if EM_POT is a donor, it also applies to OB strata. This assumption 
# # is not needed since OB data doesn't rely on EM!
# 
# # FIXME - If we get average weight data from the EM strata through either method, could we assume that the ZERO pool would
# # also benefit?
# 
# dmn_ispn_res_pool[ADP == 2022 & GEAR =="POT"]                 # Prox only
# dmn_ispn_res_pool_shoresidepotem[ADP == 2022 & GEAR =="POT"]  # 1 in 1
# dmn_ispn_res_pool_shoresidepotem2[ADP == 2022 & GEAR =="POT"] # 1 in 2
# 
# 
# #==========================#
# # Paired EM + Observers ####
# #==========================#
# 
