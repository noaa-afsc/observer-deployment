# TODO What rates would we need for OB + EM design?
# TODO How much more overlap do we get from the shoreside EM design?

library(data.table)         # Data wrangling
library(ggplot2)            # Plotting
library(sf)                 # Spatial analyses
library(dplyr)              # Data wrangling sf objects
library(flextable)          # Nicer tables in RMarkdown
library(officer)            # Better formatting of flextables
library(gridExtra)          # For combining plots and saving multiple figures to a single PDF

#======================================================================================================================#
# Data Prep ------------------------------------------------------------------------------------------------------------
#======================================================================================================================#

# Fishing effort data from 2018 to 2021
# `spatiotemporal_boxes.rdata' is generated by /analyses/spatiotemporal_boxes/data_prep.R

# TODO When testing is done, remove the line below!
load("analyses/allocation_evaluation/allocation_evaluation.RData")   # loads pc_effort_dt
val_2018_2022_dt <- pc_effort_dt[ADP %in% 2018:2022]

# Load the ADFG statistical area shapefile. '../' is needed for Rmarkdown to climb into parent folders.
stat_area_sf <- st_read(
  dsn = "source_data/ADFG_Stat_Area_shapefile/PVG_Statewide_2001_Present_GCS_WGS1984.shp", quiet = T) %>%
  select(STAT_AREA) %>%
  st_transform(crs = 3467)

# Load the Alaska map sf objects
load("source_data/ak_shp.rdata")      # shp_land, shp_nmfs, and shp_centroids added to global

#================#
## Trip Costs ----
#================#

# Use average values from the 2023 Final ADP for now. Also, roughly using trip_end - trip_start + 1 for now until we get
# a better handle on future monitoring costs.
ob_cpd <- 4896623 / 3094         # $1582.619/day
fgem_cpd <- 1e6 / (1040+735)     # $ 563.380/day
trwem_cpd <- 600                 # $600/day according to JF estimates used in set_budget.R in 2022 Final ADP repo
# Get average trip length for all strata, using TRIP_END - TRIP_START + 1
# This function counts number of unique days between each trip target date and landing date
# use this to count days for non-observed trips, which already have a modeled 'DAYS' estimate.
# day_count <- function(x) {
#   length(unique(unlist(apply(x, 1, function(y) as.numeric(as.Date(y[1])) : as.numeric(as.Date(y[2])), simplify = F))))
# }
# val_2018_2022_dt[POOL != "OB", DAYS := day_count(.SD), by = .(TRIP_ID), .SDcols = c("TRIP_TARGET_DATE", "LANDING_DATE")]
trip_cost_dt <- unique(val_2018_2022_dt[, .(ADP, STRATA, TRIP_ID, DAYS)])[, .(MEAN_TRIP_DAYS = mean(DAYS)), by = .(ADP, STRATA)]
# trip_cost_dt <- unique(val_2018_2022_dt[STRATA != "ZERO", .(ADP, STRATA, TRIP_ID, START, END)])[
# ][, .(MEAN_TRIP_DAYS = mean(as.numeric(END - START, units = "days") + 1)), by = .(ADP, STRATA)]
# Merge in day costs
trip_cost_dt[, CPD := fcase(
  STRATA == "EM_TRW", trwem_cpd,
  STRATA %in% c("EM_POT", "EM_HAL"), fgem_cpd,
  STRATA %in% c("OB_HAL", "OB_POT", "OB_TRW"), ob_cpd)]
# Calculate cost per trip
trip_cost_dt[, CPT := MEAN_TRIP_DAYS * CPD]
trip_cost_dt[STRATA == "ZERO", ':=' (CPD = 0, CPT = 0)]

#====================#
## Load Functions ----
#====================#

source("analyses/allocation_evaluation/functions.R")    

#==========================#
## Apply Box Definition ----
#==========================#

# Will continue to use 200km spatial hex cells and 1-week temporal definition for boxes

# Box definition without stratifying by FMP
system.time(box_res <- define_boxes(
  val_2018_2022_dt, c(2e5, 2e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
  year_col = "ADP", stratum_cols = "STRATA", dmn_cols = c("BSAI_GOA", "GEAR"), geom = T))
# Box definition with FMP stratified, split by BSAI and GOA
system.time(box_res_fmp <- define_boxes(
  val_2018_2022_dt, c(2e5, 2e5), time = c("week", 1, "TRIP_TARGET_DATE", "LANDING_DATE"),
  year_col = "ADP", stratum_cols = c("STRATA", "BSAI_GOA"), dmn_cols = c("GEAR"), geom = T ))

# We have two proposed designs that intend to improve the degree of overlap of average weight/biological data with the
# fixed-gear EM and zero-coverage fleets. Before going into detail how those designs work, let's first establish the
# existing level of overlap under an example scenario. We'll use the 'Proximity' allocation scheme with a $4.5M budget
# and the existing stratification scheme (without FMP being split by BSAI vs GOA). To evaluate the overlap of biological 
# data for the FG-EM and zero-coverage pools, we will categorize fishing effort into domains that further subdivide our 
# boxes by gear type and FMP, which allows us to calculate the expected proportion of trips in a domain that will be 
# within or neighboring a sampled box with biological data (interspersion of biological data within a domain).
# Presumably, if new designs collect more biological data,  especially in domains where that data is not being
# collected, the domain interspersion will be higher.

sample_rate_vec <- seq(from = 0.005, to = 0.95, by = 0.0001)

# First, get the metrics for proximity method 
system.time(ispn_res <- calculate_interspersion(box_res, sample_rate_vec, omit_strata = "ZERO"))
system.time(index_res <- calculate_index(ispn_res, trip_cost_dt))
budget_tbl <- data.table(INDEX_COST = 4.5e6) # Now, we have to assume a budget to see what rates were afforded
group_cols <- unlist(index_res$params[c("year_col", "stratum_cols")], use.names = F)  # Extract grouping columns
rates_4.5M <- index_res$rates[
][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols]  # Allocated rates for proximity method

# Do the same when stratifying by FMP
system.time(ispn_res_fmp <- calculate_interspersion(box_res_fmp, sample_rate_vec, omit_strata = "ZERO"))
system.time(index_res_fmp <- calculate_index(ispn_res_fmp, trip_cost_dt))
group_cols <- unlist(index_res_fmp$params[c("year_col", "stratum_cols")], use.names = F)  # Extract grouping columns
rates_4.5M_fmp <- index_res_fmp$rates[
][, .SD[budget_tbl, on = .(INDEX_COST), roll = "nearest"], by = group_cols]  # Allocated rates for proximity method

# Evaluate the proximity method, comparing to overlap of OB_HAL and OB_POT data to itself and dependent strata. 'box_res'
# was created with dmn_cols = c("BSAI_GOA", "GEAR") so that domains are boxes further subdivided by gear and FMP.

#======================================================================================================================#
## PROXIMITY -----------------------------------------------------------------------------------------------------------
#======================================================================================================================#

stratum_cols_og <- box_res$params$stratum_cols
stratum_dt_og <- unique(box_res$dmn$strata_dmn_n_dt[, ..stratum_cols_og])  #Get all stratum_cols in dataset
setorderv(stratum_dt_og, colnames(stratum_dt_og))
stratum_dt_og[, STRATUM_ID := .I]
acceptor_donor_lst_og <- c(
  rep(list(4:5), times = 2),                # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_og) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
dmn_insp_og <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_og)
# summary tables
dmn_insp_smry_og <- dmn_interspersion_smry(dmn_insp_og)
# summary plots
dmn_insp_plot_og <- dmn_interspersion_plot(dmn_insp_og, design_desc = "Prox")
dmn_insp_plot_og$PLOTS$HAL$`2022`

#======================================================================================================================#
## PROX STRATIFIED BY FMP ----------------------------------------------------------------------------------------------
#======================================================================================================================#

stratum_cols_fmp <- box_res_fmp$params$stratum_cols
stratum_dt_fmp <- unique(box_res_fmp$dmn$strata_dmn_n_dt[, ..stratum_cols_fmp])  #Get all stratum_cols in dataset
setorderv(stratum_dt_fmp, colnames(stratum_dt_fmp))
stratum_dt_fmp[, STRATUM_ID := .I]
acceptor_donor_lst_fmp <- c(
  rep(list(6:9), times = 4),                # EM_HAL.BSAI, EM_HAL.GOA, EM_POT.BSAI and EM_POT.GOA
  list(5),                                  # EM_TRW.BSAI
  rep(list(6:9), times = 4),                # OB_HAL.BSAI, OB_HAL.GOA, OB_POT.BSAI and OB_POT.GOA
  rep(list(10:11), times = 2),              # OB_TRW.BSAI and  OB_TRW.GOA
  rep(list(6:9), times = 2)                 # ZERO.BSAI and ZERO.GOA
)
names(acceptor_donor_lst_fmp) <- apply(stratum_dt_fmp[, ..stratum_cols_fmp], 1, function(x) paste0(x, collapse = "."))
dmn_insp_fmp <- calculate_dmn_interspersion3(box_res_fmp, rates_4.5M_fmp, stratum_dt_fmp, acceptor_donor_lst_fmp)
# summary tables
dmn_insp_smry_fmp <- dmn_interspersion_smry(dmn_insp_fmp)
# summary plots
dmn_insp_plot_fmp <- dmn_interspersion_plot(dmn_insp_fmp, design_desc = "Prox+FMP")
dmn_insp_plot_fmp$PLOTS$HAL$`2022`

#======================================================================================================================#
## SHORESIDE POT EM ----------------------------------------------------------------------------------------------------
#======================================================================================================================#

# If All EM_POT vessels also had all trips monitored shoreside for biologicals by observers
acceptor_donor_lst_spem <- c(
  rep(list(c(2,4,5)), times = 2),                # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_spem) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
dmn_insp_spem <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_spem)
# summary tables
dmn_insp_smry_spem <- dmn_interspersion_smry(dmn_insp_spem)
# summary plots
dmn_insp_plot_spem <- dmn_interspersion_plot(dmn_insp_spem, design_desc = "Shoreside Pot EM")
dmn_insp_plot_spem$PLOTS$HAL$`2022`

#======================================================================================================================#
## EM + OB -------------------------------------------------------------------------------------------------------------
#======================================================================================================================#

# what if we put Observers on all or a subset of FG_EM trips selected for monitoring?
acceptor_donor_lst_emob <- c(
  rep(list(c(1,2,4,5)), times = 2),         # 1-2: EM_HAL and EM_POT 
  list(3),                                  # 3: EM_TRW
  rep(list(4:5), times = 2),                # 4-5: OB_HAL and OB_POT
  list(6),                                  # 6: OB_TRW
  list(4:5)                                 # 7: ZERO
)
names(acceptor_donor_lst_emob) <- apply(stratum_dt_og[, ..stratum_cols_og], 1, function(x) paste0(x, collapse = "."))
# If we assume all trips also take an observer...
dmn_insp_emob_1in1 <- calculate_dmn_interspersion3(box_res, rates_4.5M, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in1 <- dmn_interspersion_smry(dmn_insp_emob_1in1)
dmn_insp_plot_emob_1in1 <- dmn_interspersion_plot(dmn_insp_emob_1in1, design_desc = "Shoreside Pot EM")
# or 1 in 2?
rates_emob_1in2 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 2]
dmn_insp_emob_1in2 <- calculate_dmn_interspersion3(box_res, rates_emob_1in2, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in2 <- dmn_interspersion_smry(dmn_insp_emob_1in2)
dmn_insp_plot_emob_1in2 <- dmn_interspersion_plot(dmn_insp_emob_1in2, design_desc = "Shoreside Pot EM")
# or 1 in 4
rates_emob_1in4 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 4]
dmn_insp_emob_1in4 <- calculate_dmn_interspersion3(box_res, rates_emob_1in4, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in4 <- dmn_interspersion_smry(dmn_insp_emob_1in4)
dmn_insp_plot_emob_1in4 <- dmn_interspersion_plot(dmn_insp_emob_1in4, design_desc = "Shoreside Pot EM")
# or 1 in 8
rates_emob_1in8 <- copy(rates_4.5M)[STRATA %in% c("EM_HAL", "EM_POT"), SAMPLE_RATE := SAMPLE_RATE / 8]
dmn_insp_emob_1in8 <- calculate_dmn_interspersion3(box_res, rates_emob_1in8, stratum_dt_og, acceptor_donor_lst_spem)
dmn_insp_smry_emob_1in8 <- dmn_interspersion_smry(dmn_insp_emob_1in8)
dmn_insp_plot_emob_1in8 <- dmn_interspersion_plot(dmn_insp_emob_1in8, design_desc = "Shoreside Pot EM")

# Save Outputs
if(F) {
  save(
    rates_4.5M, rates_4.5M_fmp, rates_emob_1in2, rates_emob_1in4, rates_emob_1in8,
    dmn_insp_smry_og, dmn_insp_smry_fmp, dmn_insp_smry_spem,
    dmn_insp_plot_og, dmn_insp_plot_fmp, dmn_insp_plot_spem,
    dmn_insp_smry_emob_1in1, dmn_insp_smry_emob_1in2, dmn_insp_smry_emob_1in4, dmn_insp_smry_emob_1in8,
    dmn_insp_plot_emob_1in1, dmn_insp_plot_emob_1in2, dmn_insp_plot_emob_1in4, dmn_insp_plot_emob_1in8,
    file = "analyses/allocation_evaluation/TEST_dmn_data.rdata"
  )
}
