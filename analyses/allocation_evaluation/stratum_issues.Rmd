---
title: "Post PCFMAC data exploration"
author: "Geoff_Mayhew"
date: '2023-02-08'
output: html_document
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = F, fig.align = 'center')  # echo must be TRUE for code folding to work!

library(data.table)         # Data wrangling
library(ggplot2)            # Plotting
library(flextable)          # Cleaner tables for Rmarkdown
library(sf)                 # Spatial analyses
library(dplyr)              # Data wrangling sf objects

load("stratum_issues.Rdata")  # Generated by analyses/allocation_evalation/stratum_issues.R script
```

### How many trips fished multiple gear types?

\
\
**Table 1.** Count of trips with multiple gear types by Year and Stratum
```{r multi_gear_trips_tbl}

t1 <- dcast(effort_pc_gear_n, STRATA_NEW + GEARS ~ ADP, value.var = "N", fill = 0) %>%
  flextable() %>% autofit()
t1
```
\
\
```{r multi_gear_trips_fig}
ggplot(effort_pc_gear, aes(x = ADP, fill = GEARS)) + geom_bar() + facet_wrap(~STRATA_NEW, scale = "free_y") + labs(x = "Year")
```
**Figure 1.** Counts of trips with one or multiple gear types by year and stratum.
\
\
**Table 2.** Percent of trips with one or multiple gear types by Year and Stratum
```{r multi_gear_trips_tbl_perc}

t2 <- dcast(effort_pc_gear_n, STRATA_NEW + GEARS ~ ADP, value.var = "PERC", fill = 0) %>%
  flextable() %>% autofit()
t2
```
\
\
```{r multi_gear_trips_fig_perc}
ggplot(effort_pc_gear, aes(x = ADP, fill = GEARS)) + geom_bar(position = "fill") + facet_wrap(~STRATA_NEW) +
  labs(x = "Year", y = "Proportion")
```
**Figure 2.** Proportion of trips with one or multiple gear types by year and stratum.
\
\

### How many trips fished multiple FMPs?

\
\
```{r multi_fmp_trips_tbl}
t3 <- dcast(effort_pc_fmp_n, STRATA_NEW + FMPs ~ ADP, value.var = "N", fill = 0) %>%
  flextable() %>% autofit()
t3
```
**Table 3.** Count of trips that fished in one or multiple FMPs by year and stratum.
\
\
```{r multi_fmp_trips_fig}
ggplot(effort_pc_fmp, aes(x = ADP, fill = FMPs)) + geom_bar() + facet_wrap(~STRATA_NEW, scale = "free_y")
```
**Figure 3.** Count of trips that fished in one or multiple FMPs by year and stratum.
\
\
**Table 4.** Percent of trips that fished in one or multiple FMPs by year and stratum.
```{r multi_fmp_trips_tbl_perc}
t4 <- dcast(effort_pc_fmp_n, STRATA_NEW + FMPs ~ ADP, value.var = "PERC", fill = 0) %>%
  flextable() %>% autofit()
t4
```
\
\
**Figure 4.** Proportion of trips that fished in one or multiple FMPs by year and stratum.
```{r multi_fmp_trips_fig_perc}
ggplot(effort_pc_fmp, aes(x = ADP, fill = FMPs)) + geom_bar(position = "fill") + facet_wrap(~STRATA_NEW) + labs(x = "Year", y= "Proportion")
```
\
\

### Fixed-gear EM vessels that previously took observers

\
\
I used the 2023 list of fixed-gear EM vessels (179 vessels) and searched NORPAC.atl_fma_trip for any fished trips that were observed (records go back to 2008).
\
\
```{r fg_em_history, fig.width = 8, fig.height = 6}
ggplot(fg_em_ob_pull_count, aes(x = as.character(YEAR), y = as.character(PERMIT), fill = TRIP_N, label = TRIP_N)) + 
  geom_tile() + scale_fill_viridis_c(trans = "sqrt") + 
  labs(
    x = "Year", y = "Permit", fill = "Count of fished trips with an observer",
    subtitle = "Vessels with filled 'NA' column have no observer records since 2008.") + theme(legend.position = "bottom")
```
**Figure 5.** Yearly count of fishing trips observed by 2023 fixed-gear EM vessels. Vessels with a filled 'NA' column on the right have no history of observed trips since 2008.
\
\
`r fg_em_ob_pull_count[TRIP_N==0, .N]` vessels, or `r round(fg_em_ob_pull_count[TRIP_N==0, .N] / nrow(fg_em)*100, 2)`%, have not taken an observer since 2008. Therefore, **`r (100 - (round(fg_em_ob_pull_count[TRIP_N==0, .N] / nrow(fg_em)*100, 2)))`%** of vessels in the current FG-EM pool have taken an observer before.
\
\
```{r fg_em_histogram}
ggplot(fg_em_ob_pull_tot, aes(x = TOT_N, fill = as.factor(LENGTH))) + geom_histogram(bins = 30) + 
  labs(
    x = "Total fished trips with an observer", y = "Count of fixed-gear EM vessels", fill = "Vessel length",
    subtitle = paste0(count_3, "% vessels with >=3 trips and ", count_5, "% vessels with >= 5 trips.")) + 
  scale_fill_viridis_d(breaks = seq(40, 140, 10))
```
**Figure 6.** Histogram of count of observed fished trips taken by 2023 fixed-gear EM vessels. `r count_3`% of FG-EM vessels have taken observers on 3 or more trips, and `r count_5`% of FG-EM vessels have taken observers on 5 or more trips.


