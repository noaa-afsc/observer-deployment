---
title: "Between-Trip Variance Evaluation Metric"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

```{r start, include=FALSE}
# Get packages
library(data.table)
library(tidyverse)

# Get data
load("source_data/2024_Draft_ADP_data.rdata")
rm(list=setdiff(ls(), c("trips_melt", "efrt", "work.data")))

# Settings
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 9999)
```

```{r wrangle}
# Convert optimization metrics to wide format
metrics <- dcast(trips_melt[, .(TRIP_ID, STRATA = strata_ID, METRIC = Metric, VALUE = Value)], TRIP_ID + STRATA ~ METRIC, value.var = "VALUE")

# Join optimization metric values with the most recent year of trips
dat <- metrics[efrt[ADP == 2022], on = .(TRIP_ID, STRATA), nomatch=0]

# Total number of trips per stratum
dat[, N := uniqueN(TRIP_ID), keyby = .(STRATA)]

# Sum metrics by columns of interest
dat <- dat[, .(chnk_psc = sum(chnk_psc), hlbt_psc = sum(hlbt_psc), discard = sum(discard)), by = .(TRIP_ID, STRATA, N)]

# Calculate between-trip standard deviation
dat <- dat[, .(sd_chnk = sd(chnk_psc), sd_hlbt = sd(hlbt_psc), sd_discard = sd(discard)), by = .(STRATA, N)]

# Join with the full range of sample sizes for each stratum  
dat <- dat[, .(n = 2:N), by = .(STRATA)][dat, on = .(STRATA)]

# Convert to long format  
dat <- melt(dat, id.vars = c("STRATA", "n", "N"), variable.name = "metric", value.name = "sd")

# Calculate standard error  
dat[, se := sqrt((N-n)/N) * sqrt(1/n) * sd]

# Recode strata and metric names
dat[, ":=" (STRATA = recode(STRATA, "EM_HAL" = "EM HAL", "EM_POT" = "EM POT", "EM_TRW_EFP" = "EM TRW EFP"), metric = recode(metric, "sd_chnk" = "Chinook PSC", "sd_hlbt" = "Halibut PSC", "sd_discard" = "Groundfish discards"))]


```

```{r plot, echo = FALSE}
ggplot(dat, aes(x = n, y = se)) +
  geom_line() +
  facet_grid(metric ~ STRATA, scales = "free") +
  theme_bw()
```

