---
title: "Box Size Exploration"
author: "Geoff_Mayhew"
date: '2022-10-25'
output: 
  html_document:
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = T, fig.align = 'center')  # echo must be TRUE for code folding to work!

# Load Packages ----

library(data.table)         # Data wrangling
library(ggplot2)            # Plotting
library(flextable)          # Cleaner tables for Rmarkdown
library(sf)                 # Spatial analyses
library(dplyr)              # Data wrangling sf objects

# Load Data ----

# `spatiotemporal_boxes.rdata' is generated by /analyses/spatiotemporal_boxes/data_prep.R
load("spatiotemporal_boxes.RData")

# Load the ADFG statistical area shapefile. '../' is needed for Rmarkdown to climb into parent folders.
stat_area_sf <- st_read(
  dsn = "../../source_data/ADFG_Stat_Area_shapefile/PVG_Statewide_2001_Present_GCS_WGS1984.shp", quiet = T) %>%
  select(STAT_AREA) %>%
  st_transform(crs = 3467)

# Load the Alaska map sf objects
load("../../source_data/ak_shp.rdata")      # shp_land, shp_nmfs, and shp_centroids added to global

# Load Functions ----

source("stat_area_to_hex_fun.R")            # Load the stat_area_to_hex function

```

We are trying to decide what to use to define 'boxes' for the SEA and Cost-Weighted Boxes Design. Currently considering different temporal bins (week or weeks from TRIP_TARGET_DATE and/or LANDING_DATE), spatial bins (NMFS Area or hex grid cells derived from ADFG_STAT_AREA_CODE), including or excluding trip target (TRIP_TARGET_CODE), and perhaps tender status (TENDER). These comparisons will be stratum-specific, and may also be defined by gear type (HAL, POT, or TRW) and monitoring tool (observer or EM).

For this analysis, we'll look at partial coverage fishing trips from 2018-2021 using the 2022 ADP source data. We'll also use the 2022 coverage and stratum definitions and randomly sample pollock EFP trips. Zero pool trips will be ignored for now as we are focusing on our ability to deploy within our sample frame.

We will focus on how sparsely populated our post-strata are depending on what we used to define our post-strata. It is not useful to split post-strata into tiny pieces such that many post-strata have only have a few trips and are therefore unlikely to be sampled. Initially, we can look at the proportion of post-strata that contain only 1 trip, and later, consider the distributions of post-strata trip counts.

### (1) Original : [NMFS Area] + [1 week bins] + [Target]

Post-strata defined by NMFS Area, 1 week bins, and trip target. Gear is not used here (e.g. NPT and PTR are not split).

```{r Box 1}

box_1_dt <- unique(
  val_2018_2021_dt[, .(ADP, STRATA, NMFS_AREA, TARGET, WEEK, TRIP_ID)]
)[, .(N = uniqueN(TRIP_ID)), keyby = .(ADP, STRATA, NMFS_AREA, TARGET, WEEK)]

# Proportion of post-strata with only 1 trip
box_1_prop_1_dt <- box_1_dt[STRATA != "ZERO", .(NUM_OF_PS = .N, PROP_1 = round(sum(N==1)/.N,4)), keyby=.(ADP, STRATA)]
flextable(dcast(box_1_prop_1_dt, ADP ~ STRATA, value.var = "PROP_1")) %>% colformat_int(j = 1, big.mark = "") %>% 
  set_caption(caption = "[NMFS Area] + [1 week bins] + [Target] : Proportion of post-strata with only 1 trip.")
```

### (2) Removing Target : [NMFS Area] + [1 week bins]

Remove target and see how much it changes things.

```{r Box 2}
box_2_dt <- unique(
  val_2018_2021_dt[, .(ADP, STRATA, NMFS_AREA, WEEK, TRIP_ID)]
)[, .(N = uniqueN(TRIP_ID)), keyby = .(ADP, STRATA, NMFS_AREA, WEEK)]

# Proportion of post-strata with only 1 trip
box_2_prop_1_dt <- box_2_dt[STRATA != "ZERO", .(NUM_OF_PS = .N, PROP_1 = round(sum(N==1)/.N,4)), keyby=.(ADP, STRATA)]
flextable(dcast(box_2_prop_1_dt, ADP ~ STRATA, value.var = "PROP_1")) %>% colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[NMFS Area] + [1 week bins] + [TARGET] : Proportion of post-strata with only 1 trip.")
```

Comparing the two, excluding target has the largest impact on TRW gear strata, which already have a lesser proportion of 1-trip post-strata compared to fixed gear. EM_POT is virtually unaffected by excluding target, as this pattern is likely driven by the 1-week bins.

```{r Compare Box 1 and Box 2}
ggplot(
  data = rbind(
    cbind(box_1_prop_1_dt, Box = "[NMFS Area] + [1 week bins] + [Target]"),
    cbind(box_2_prop_1_dt, Box = "[NMFS Area] + [1 week bins]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[NMFS Area] + [1 week bins] + [Target]", "[NMFS Area] + [1 week bins]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) +
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")
```

### (3) Expand to 2-Week bins : [NMFS Area] + [2 week bins]

Now, continuing to leave target out, expand from 1-week bins to 2-week bins.

```{r Box 3}

box_3_dt <- unique(
  val_2018_2021_dt[
  ][, .(ADP, STRATA, NMFS_AREA, WEEK, TRIP_ID)
  ][, WEEK := ifelse(WEEK %% 2 == 0, WEEK - 1, WEEK)]
)[, .(N = uniqueN(TRIP_ID)), keyby = .(ADP, STRATA, NMFS_AREA, WEEK)]

# Proportion of post-strata with only 1 trip
box_3_prop_1_dt <- box_3_dt[STRATA != "ZERO", .(NUM_OF_PS = .N, PROP_1 = round(sum(N==1)/.N,4)), keyby=.(ADP, STRATA)]
flextable(dcast(box_3_prop_1_dt, ADP ~ STRATA, value.var = "PROP_1")) %>% colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[NMFS Area] + [2 week bins] : Proportion of post-strata with only 1 trip.")

ggplot(
  data = rbind(
    cbind(box_2_prop_1_dt, Box = "[NMFS Area] + [1 week bins]"),
    cbind(box_3_prop_1_dt, Box = "[NMFS Area] + [2 week bins]")
  )[STRATA != "ZERO"],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")

```

This helped, but FG is still over 20%...

### (4) Expand to 1-month bins : [NMFS Area] + [1 month bins]

```{r Box 4}

box_4_dt <- unique(
  val_2018_2021_dt[
  ][, .(ADP, STRATA, NMFS_AREA, TRIP_ID, TRIP_START, TRIP_END)
  ][, MONTH := month(TRIP_START + as.numeric(TRIP_END - TRIP_START, units = "days"))]
)[, .(N = uniqueN(TRIP_ID)), keyby = .(ADP, STRATA, NMFS_AREA, MONTH)]

# Proportion of post-strata with only 1 trip
box_4_prop_1_dt <- box_4_dt[STRATA != "ZERO", .(NUM_OF_PS = .N, PROP_1 = round(sum(N==1)/.N,4)), keyby=.(ADP, STRATA)]
flextable(dcast(box_4_prop_1_dt, ADP ~ STRATA, value.var = "PROP_1")) %>% colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[NMFS Area] + [1 month bins] : Proportion of post-strata with only 1 trip.")

ggplot(
  data = rbind(
    cbind(box_3_prop_1_dt, Box = "[NMFS Area] + [2 week bins]"),
    cbind(box_4_prop_1_dt, Box = "[NMFS Area] + [1 month bins]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[NMFS Area] + [2 week bins]", "[NMFS Area] + [1 month bins]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")

```

Even with 1-month bins, most fixed-gear strata still have 10-25% of post-strata with only 1 trip in most years. A larger issue of binning time is that the interpretation is affected by where you start binning. In some years, TRW actually has more empty post-strata in spite of larger time bins!

In reading the SEA, they described that their post-strata used 5-weeks (centered on week 3), but it wasn't immediately clear to me how they applied this (SEA Table 3). My guess is that for trips that fish on week 8, its post-stratum would include similar fishing that also occurred in weeks 6, 7, 9, and 10. That is, post-strata can overlap temporally. Let's try applying this same logic and see what we get - it should certainly do away with our issue of having large, non-overlapping temporal bins that are dependent on where divisions are made.

### (5) 5 Weeks Overlapping : [NMFS Area] + [5 weeks overlapping]

```{r Syntax-friendly version using data.table and .BY, eval = F}

# I found this syntax with data.table and .BY to be very convenient, but fairly inefficient. If we're doing some grouping and math, our machines should be able to do it in fractions of seconds. I've included this method here as it is easy to understand and troubleshoot. Think of it as a way to (relatively slowly) get the correct answer to help troubleshoot faster methods.

# '.BY' can be used in j to access the values of columns specified in 'by'. Can reference by name or index.
# For instance, if the first 'by' group is 2018, POT, 518, 10, I can use those to subset a data other than .SD!

if(F){
  
  box_5_dt <- unique(val_2018_2021_dt[, .(ADP, STRATA, NMFS_AREA, WEEK, TRIP_ID)])
  # For each unique post-stratum (ADP, STRATA, NMFS_AREA, WEEK), subset the full dataset but allowing modifiers
  box_5_dt[
  ][, .(N = box_5_dt[                              # I want to look for trips outside of .SD, so look in the parent dataset
    (ADP == .BY[["ADP"]]) &                    # Match ADP
    (STRATA == .BY[["STRATA"]]) &              # Match STRATA
    (NMFS_AREA == .BY[["NMFS_AREA"]]) &        # Match NMFS_AREA
    (WEEK %in% (.BY[["WEEK"]] + (-2:2))),      # Expand search for WEEK 2 weeks earlier and after
    uniqueN(TRIP_ID)]),                        # Count unique TRIP_IDs in post-stratum
    keyby = .(ADP, STRATA, NMFS_AREA, WEEK)
  ][, .(PROP_1 = round(sum(N == 1)/.N, 4)), keyby = .(ADP, STRATA)]    # Calculate proportion of post-strata with only 1 trip
  # 4.13 sec. Not too bad, but gets much slower when you add spatial cells later...
  
  # Adding a grouping variable for the non-overlapping post-stratum components can simplify and speed things up
  box_5_dt[, GRP := .GRP, keyby=.(ADP, STRATA, NMFS_AREA)]   # These don't overlap, so wrap them into one variable GRP
  box_5_dt[
  ][, .(N = box_5_dt[(GRP == .BY[["GRP"]]) & (WEEK %in% (.BY[["WEEK"]] + (-2:2))),  uniqueN(TRIP_ID)]),
    keyby = .(GRP, WEEK, ADP, STRATA)                # Keep ADP and STRATA here for the summary in the next step
  ][, .(PROP_1 = round(sum(N == 1)/.N, 4)), keyby = .(ADP, STRATA)]   # Calculate proportion of post-strata with only 1 trip
  # 2.88 sec
}

# When working with numeric or integer datasets, apply functions are much faster, although syntactically more complex. We will use apply functions with our dataset for speed reasons later, but for now we will try to keep the table structure more or less in place so we can still view the trips in each post-stratum.

if(F) {
  
  box_5_lst <- lapply(
    
    # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
    X = lapply(
      X = split(
        x = unique(val_2018_2021_dt[, .(ADP, STRATA, NMFS_AREA, WEEK, TRIP_ID)]), 
        by = c("ADP", "STRATA", "NMFS_AREA"), keep.by = F), 
      FUN = as.matrix),
    # Identify post-strata and search for overlapping TRIP_IDs
    FUN = function(x) {
      # Get unique post-strata (WEEK)
      x0 <- unique(x[, 1, drop = F])       # Columns: [1:WEEK]
      # For each post-stratum, find all trips with overlapping post-stratum components
      x1 <- apply(
        X = x0, MARGIN = 1, simplify = F,                             # Set simplify to false to preserve matrix dimensions
        FUN = function(y)  x[x[,1] %in% (y[1] + -2:2), , drop = F]    # WEEK within -2 and +2 weeks
      )
      # Name each element, identifying the overlapping post-stratum components 
      names(x1) <- apply(
        X = x0, MARGIN = 1, 
        FUN = function(z) paste0("WEEK_", z[1] ))
      x1
    }
  )  # 0.11 - 0.14 sec, or 26x faster
  
  # Convert back to data.table, takes 0.58sec, so only 4x faster
  int_cols <- c("CENTER_WEEK", "ADP", "NMFS_AREA")
  box_5_dt <- rbindlist(
    lapply(
      X = box_5_lst,
      FUN = function(x) rbindlist(lapply(x, as.data.table), idcol = "CENTER_WEEK")),
    idcol = "ADP.STRATA.NMFS_AREA"
  )[, CENTER_WEEK := gsub("WEEK_", "", CENTER_WEEK)
  ][, c("ADP", "STRATA", "NMFS_AREA") := tstrsplit(ADP.STRATA.NMFS_AREA, split="[.]")    # Split back into separate columns
  ][, "ADP.STRATA.NMFS_AREA" := NULL
  ][, (int_cols) := lapply(.SD, as.integer), .SDcols = int_cols][]  # Re-class 
  
  # Calculate proportion of post-strata with only 1 trip
  box_5_prop_1_dt <- box_5_dt[
  ][, .(N =  uniqueN(TRIP_ID)),keyby = .(ADP, STRATA, CENTER_WEEK, NMFS_AREA)
  ][, .(PROP_1 = round(sum(N == 1)/.N, 4)), keyby = .(ADP, STRATA)]
}

```

```{r Box 5}

# Define temporal extent as -2 to +2 weeks. Count the number of unique trips per post-stratum.

box_5_lst <- lapply(
  
  # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
  X = lapply(
    X = split(
      x = unique(val_2018_2021_dt[, .(ADP, STRATA, NMFS_AREA, WEEK, TRIP_ID)]), 
      by = c("ADP", "STRATA"), keep.by = F), 
    FUN = as.matrix),
  # Identify post-strata and search for overlapping TRIP_IDs
  FUN = function(x) {
    # Get unique post-strata (WEEK)
    x0 <- unique(x[, 1:2, drop = F])       # Columns: [1:NMFS_AREA], [2:WEEK]
    # For each post-stratum, find all trips with overlapping post-stratum components
    apply(
      X = x0, MARGIN = 1,                            
      FUN = function(y)  {
        # Identify trips in each post-stratum: Match NMFS_AREA and search for WEEK with -2 to +2 search range
        # Then count number of unique TRIP_ID (third column)
        length(unique(x[(x[,1] == y[1]) & (x[,2] %in% (y[2] + -2:2)),, drop = F][, 3])) 
      }
    )
  }
)

box_5_prop_1_dt <- cbind(
  # Split names to create ADP and STRATA columns
  rbindlist(lapply(
    X = strsplit(names(sapply(box_5_lst, function(x) round(sum(x==1) / length(x), 4))), split = "[.]"), 
    FUN = function(x) data.table(ADP = x[1], STRATA = x[2]))),
  # Calculate proportion of post-strata with only 1 trip
  NUM_OF_PS = lengths(box_5_lst),
  PROP_1 = unname(sapply(box_5_lst, function(x) round(sum(x==1) / length(x), 4)))    
)[, ADP := as.integer(ADP)][]

flextable(dcast(box_5_prop_1_dt[STRATA != "ZERO"], ADP ~ STRATA, value.var = "PROP_1")) %>% 
  colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[NMFS Area] + [5 week overlapping] : Proportion of post-strata with only 1 trip.")

ggplot(
  data = rbind(
    cbind(box_4_prop_1_dt, Box = "[NMFS Area] + [1 month bins]"),
    cbind(box_5_prop_1_dt, Box = "[NMFS Area] + [5 week overlapping]")
  )[STRATA != "ZERO"],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")
```

We see a pretty drastic decrease in the number of post-strata with only 1 trip! Most fixed-gear post-strata are below 6% in most years. Even though the temporal sizes of the post-strata are relatively similar (1 month vs 5 week), trips are no longer temporally exclusive to one post-stratum.

We can compare this definition to our second definition (NMFS Area, 1-week bins and no target), which is the same except that we allow trips to overlap into post-strata 2 weeks prior and after. Note that the number of post-strata is identical.

```{r compare Box 2 and Box 5}

ggplot(
  data = rbind(
    cbind(box_2_prop_1_dt, Box = "[NMFS Area] + [1 week bins]"),
    cbind(box_5_prop_1_dt, Box = "[NMFS Area] + [5 week overlapping]")
  )[STRATA != "ZERO"],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")

```

### (6) 250km hex cells : [250km Hex Cell] + [5 week overlapping]

Similar to allowing single trips to span in time, we can also do this in space. We have been using NMFS areas to spacially bin our trips so far, but we can instead place these trips into equal-area hex cells and instead define the spatial component of post-strata as trips within a specified distance of the center of the cell. The size of the cells themselves are not particularly important here (they influence the total number of post-strata), but the distance to neighbors is very important. For now, we will use hex cells with 250km side lengths.

First, let's visualize the size of these hex cells:

```{r hex cell intro `}

# Let's start with 250km wide hex cells. Use the stat_area_to_hex_fun() to create a hex grid that identifies which ADFG stat area centroid fall into each hex cell.
stat_area_250km_lst <- stat_area_to_hex_fun(2.5e5, stat_area_sf)

# Apply 250km search radius for neighboring cells using centroids and compile each HEX_ID with its neighbors (NEW_HEX_ID) in a data.table that can be quickly merged on HEX_ID.

# Get distance of each cell centroid to other centroids. This list is used such that item #5 contains a vector of the HEX_IDs of cell #5 and its neighbors. This list allows us to quickly identify which cells should be included in a given post-stratum.
stat_area_250km_dist_rad_250_lst <- suppressWarnings(apply(
  X = round(st_distance(st_centroid(stat_area_250km_lst$HEX_GEOMETRY))), 
  MARGIN = 1, 
  FUN = function(x) which(x <= 2.5e5)))

ggplot() + 
  geom_sf(data = shp_nmfs, color="red", fill = NA) + geom_sf(data = shp_land) + 
  geom_sf(data = stat_area_250km_lst$HEX_GEOMETRY, color = "blue", fill = NA) +
  scale_x_continuous(breaks = seq(180, 260, 10)) + 
  labs(subtitle = "NMFS area in red, 250km cell in blue.")
```

With 250km-sized hex cells, there are 99 total cells. Granted, not all have fishing in them, but this gives us a starting point to then place each trip into one or more hex cells. When identifying post-strata centered on each cell, we will employ a 250km search radius around each cell, essentially making the spatial extent of each post-stratum cover the area of 7 hex cells. To compare the size of one hex cell and seven hex cells to the area of NMFS areas, see the histogram below.

```{r hex cell intro 2, fig.width = 6, fig.height = 3}
mean_cell_area_km2_250 <- mean(as.numeric(st_area(stat_area_250km_lst$HEX_GEOMETRY)) / 1e6)
# If you have a 250km search radius for each cell (i.e., a cell and its 6 neighboring cells), the post-stratum has a spatial size of 379K km^2.

ggplot(data.table(AREA = as.numeric(st_area(shp_nmfs)) / 1e6)) + 
  geom_histogram(aes(x = AREA), bins = 15) +
  geom_vline(xintercept = mean_cell_area_km2_250, color = "red") + 
  geom_vline(xintercept = mean_cell_area_km2_250*7, color = "blue") + 
  labs(x = "Area in km^2", subtitle = "Histogram of NMFS area size in km^2.\nArea of one 250km size cell in red, Area of one cell and six neighbors in blue.")
```

In short, 250km side hex cells are approximately the size of the smallest NMFS areas, and the spatial extent of the post-strata (using a 250km search radius) is slightly greater than the largest NMFS areas.

Now that we've define our spatial extent, let's see how the overlapping of hex cells compare with NMFS areas.

```{r Box 6}

# Define temporal extent as -2 to +2 weeks and spatial extent as 250km hex cell and neighboring cells within 250km. 
# Counting the number of unique trips per post-stratum.

box_6_dt <- unique(val_2018_2021_dt[, .(ADP, STRATA, TRIP_ID, ADFG_STAT_AREA_CODE, WEEK)])
# FIXME For some reason 515832 is missing from the shapefile. 
# https://www.adfg.alaska.gov/static/fishing/PDFs/commercial/chart01_gulf.pdf
# 515832 encloses East Amatuli Island , bordering 515831, so coerce it to that.
# In the future, try pulling the ADFG shapefiles from the ZONE schema, ZONE.STAT6 table has STAT_AREA, and 515832 is present with SDO Geometry. I took a stab at this but have to figure out how to appropriately handle SDO_GEOMETRY data in Oracle...
box_6_dt <- unique(box_6_dt[ADFG_STAT_AREA_CODE == 515832, ADFG_STAT_AREA_CODE := 515831])

# Merge the hex cells by ADFG_STAT_AREA_CODE, then drop ADFG_STAT_AREA_CODE to get unique HEX_ID for each trip
box_6_dt <- unique(data.table(stat_area_250km_lst$STAT_AREA_HEX_DF)[
][box_6_dt, on = .(ADFG_STAT_AREA_CODE)
][, -"ADFG_STAT_AREA_CODE"])

# Now search for neighbors using the overlapping temporal and spatial extents
box_6_lst <- lapply(
  
  # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
  X = lapply(
    X = split(
      x = unique(box_6_dt[, .(ADP, STRATA, HEX_ID, WEEK, TRIP_ID)]), 
      by = c("ADP", "STRATA"), keep.by = F), 
    FUN = as.matrix),
  # Identify post-strata and search for overlapping TRIP_IDs
  FUN = function(x) {
    # Get unique post-strata (WEEK)
    x0 <- unique(x[, 1:2, drop = F])       # Columns: [1:HEX_ID], [2:WEEK]
    # For each post-stratum, find all trips with overlapping post-stratum components
    apply(
      X = x0, MARGIN = 1,                            
      FUN = function(y)  {
        # Identify trips in each post-stratum: Match NMFS_AREA and search for WEEK with -2 to +2 search range
        # Then count number of unique TRIP_ID (third column)
        length(unique(x[(x[,1] %in% stat_area_250km_dist_rad_250_lst[[ y[1] ]]) & (x[,2] %in% (y[2] + -2:2)),, drop = F][, 3])) 
      }
    )
  }
) # 0.36 sec

# Determine total number of post-strata and proportion of post-strata with only one trip.
box_6_prop_1_dt <- cbind(
  # Split names to create ADP and STRATA columns
  rbindlist(lapply(
    X = strsplit(names(sapply(box_6_lst, function(x) round(sum(x==1) / length(x), 4))), split = "[.]"), 
    FUN = function(x) data.table(ADP = x[1], STRATA = x[2]))),
  # Calculate proportion of post-strata with only 1 trip
  NUM_OF_PS = lengths(box_6_lst),
  PROP_1 = unname(sapply(box_6_lst, function(x) round(sum(x==1) / length(x), 4)))    
)[, ADP := as.integer(ADP)][]

flextable(dcast(box_6_prop_1_dt[STRATA != "ZERO"], ADP ~ STRATA, value.var = "PROP_1")) %>% 
  colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[250km Hex] + [5 week overlapping] : Proportion of post-strata with only 1 trip.")

ggplot(
  data = rbind(
    cbind(box_5_prop_1_dt, Box = "[NMFS Area] + [5 week overlapping]"),
    cbind(box_6_prop_1_dt, Box = "[250km Hex] + [5 week overlapping]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[NMFS Area] + [5 week overlapping]", "[250km Hex] + [5 week overlapping]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")
```

With a radius of 250km per 250km cell we find that nearly all post-strata have more than one trip (\< 3% of post-strata across all years and strata).

Out of curiosity, what if we had smaller cells and a smaller search radius: 125km each? Each cell and the total spatial extent of the post-strata would be 1/4 of the previous 250km cells.

### (7) 125km hex cells : [125km Hex Cell] + [5 week overlapping]

```{r Box 7 prep 1}

stat_area_125m_lst <- stat_area_to_hex_fun(1.25e5, stat_area_sf)

# Apply 250km search radius for neighboring cells using centroids and compile each HEX_ID with its neighbors (NEW_HEX_ID) in a data.table that can be quickly merged on HEX_ID.

# Get distance of each cell centroid to other centroids. This list is used such that item #5 contains a vector of the HEX_IDs of cell #5 and its neighbors. This list allows us to quickly identify which cells should be included in a given post-stratum.
stat_area_125km_dist_rad_125_lst <- suppressWarnings(apply(
  X = round(st_distance(st_centroid(stat_area_125m_lst$HEX_GEOMETRY))), 
  MARGIN = 1, 
  FUN = function(x) which(x <= 1.25e5)))

# Map with 125km Hex cells and NMFS areas 
ggplot() + 
  geom_sf(data = shp_nmfs, color="red", fill = NA) + geom_sf(data = shp_land) + 
  geom_sf(data = stat_area_125m_lst$HEX_GEOMETRY, color = "blue", fill = NA) +
  scale_x_continuous(breaks = seq(180, 260, 10)) + 
  labs(subtitle = "NMFS area in red, 125km cell in blue.")
```

```{r Box 7 prep 2, fig.width = 6, fig.height = 3}
mean_cell_area_km2_125 <- mean(as.numeric(st_area(stat_area_125m_lst$HEX_GEOMETRY)) / 1e6)

# Histogram of NMFS Area area in km^2 vs 125 hex cell and with 6 neighbors
ggplot(data.table(AREA = as.numeric(st_area(shp_nmfs)) / 1e6)) + 
  geom_histogram(aes(x = AREA), bins = 15) +
  geom_vline(xintercept = mean_cell_area_km2_125, color = "red") + 
  geom_vline(xintercept = mean_cell_area_km2_125*7, color = "blue") + 
  labs(x = "Area in km^2", subtitle = "Histogram of NMFS area size in km^2.\nArea of one 125km size cell in red, Area of one cell and six neighbors in blue.")
```

```{r box 7}
# Define temporal extent as -2 to +2 weeks and spatial extent as 125km hex cell and neighboring cells within 125km. 
# Counting the number of unique trips per post-stratum.
box_7_dt <- unique(
  val_2018_2021_dt[
  ][, .(ADP, STRATA, TRIP_ID, ADFG_STAT_AREA_CODE, WEEK)
  ][ADFG_STAT_AREA_CODE == 515832, ADFG_STAT_AREA_CODE := 515831])

# Merge the hex cells by ADFG_STAT_AREA_CODE, then drop ADFG_STAT_AREA_CODE to get unique HEX_ID for each trip
box_7_dt <- unique(data.table(stat_area_125m_lst$STAT_AREA_HEX_DF)[
][box_7_dt, on = .(ADFG_STAT_AREA_CODE)
][, -"ADFG_STAT_AREA_CODE"])

# Now search for neighbors using the overlapping temporal and spatial extents
box_7_lst <- lapply(
  
  # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
  X = lapply(
    X = split(
      x = unique(box_7_dt[, .(ADP, STRATA, HEX_ID, WEEK, TRIP_ID)]), 
      by = c("ADP", "STRATA"), keep.by = F), 
    FUN = as.matrix),
  # Identify post-strata and search for overlapping TRIP_IDs
  FUN = function(x) {
    # Get unique post-strata (WEEK)
    x0 <- unique(x[, 1:2, drop = F])       # Columns: [1:HEX_ID], [2:WEEK]
    # For each post-stratum, find all trips with overlapping post-stratum components
    apply(
      X = x0, MARGIN = 1,                            
      FUN = function(y)  {
        # Identify trips in each post-stratum: Match NMFS_AREA and search for WEEK with -2 to +2 search range
        # Then count number of unique TRIP_ID (third column)
        length(unique(x[(x[,1] %in% stat_area_125km_dist_rad_125_lst[[ y[1] ]]) & (x[,2] %in% (y[2] + -2:2)),, drop = F][, 3])) 
      }
    )
  }
) # 0.69 sec

# Determine total number of post-strata and proportion of post-strata with only one trip.
box_7_prop_1_dt <- cbind(
  # Split names to create ADP and STRATA columns
  rbindlist(lapply(
    X = strsplit(names(sapply(box_7_lst, function(x) round(sum(x==1) / length(x), 4))), split = "[.]"), 
    FUN = function(x) data.table(ADP = x[1], STRATA = x[2]))),
  # Calculate proportion of post-strata with only 1 trip
  NUM_OF_PS = lengths(box_7_lst),
  PROP_1 = unname(sapply(box_7_lst, function(x) round(sum(x==1) / length(x), 4)))    
)[, ADP := as.integer(ADP)][]

# Table of proportion of post-strata with only 1 trip
flextable(dcast(box_7_prop_1_dt[STRATA != "ZERO"], ADP ~ STRATA, value.var = "PROP_1")) %>% 
  colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[125km Hex] + [5 week overlapping] : Proportion of post-strata with only 1 trip.")

# Comparison of PROP_1 between 250km hex cell and 125 km hex cell
ggplot(
  data = rbind(
    cbind(box_6_prop_1_dt, Box = "[250km Hex] + [5 week overlapping]"),
    cbind(box_7_prop_1_dt, Box = "[125km Hex] + [5 week overlapping]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[250km Hex] + [5 week overlapping]", "[125km Hex] + [5 week overlapping]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")
```

Let's do a 200km size cell to get an intermediate between 125km and 250km (\~2/3 of the area of 250km).

### (8) 200km hex cells : [200km Hex Cell] + [5 week overlapping]

```{r Box 8 prep 1}

stat_area_200km_lst <- stat_area_to_hex_fun(2e5, stat_area_sf)

# Apply 250km search radius for neighboring cells using centroids and compile each HEX_ID with its neighbors (NEW_HEX_ID) in a data.table that can be quickly merged on HEX_ID.

# Get distance of each cell centroid to other centroids. This list is used such that item #5 contains a vector of the HEX_IDs of cell #5 and its neighbors. This list allows us to quickly identify which cells should be included in a given post-stratum.
stat_area_200km_dist_rad_200_lst <- suppressWarnings(apply(
  X = round(st_distance(st_centroid(stat_area_200km_lst$HEX_GEOMETRY))), 
  MARGIN = 1, 
  FUN = function(x) which(x <= 2e5)))

# Map with 200km Hex cells and NMFS areas 
ggplot() + 
  geom_sf(data = shp_nmfs, color="red", fill = NA) + geom_sf(data = shp_land) + 
  geom_sf(data = stat_area_200km_lst$HEX_GEOMETRY, color = "blue", fill = NA) +
  scale_x_continuous(breaks = seq(180, 260, 10)) + 
  labs(subtitle = "NMFS area in red, 200km cell in blue.")
```

```{r Box 8 prep 2, fig.width = 6, fig.height = 3}
mean_cell_area_km2_200 <- mean(as.numeric(st_area(stat_area_200km_lst$HEX_GEOMETRY)) / 1e6)

# Histogram of NMFS Area area in km^2 vs 125 hex cell and with 6 neighbors
ggplot(data.table(AREA = as.numeric(st_area(shp_nmfs)) / 1e6)) + 
  geom_histogram(aes(x = AREA), bins = 15) +
  geom_vline(xintercept = mean_cell_area_km2_200, color = "red") + 
  geom_vline(xintercept = mean_cell_area_km2_200*7, color = "blue") + 
  labs(x = "Area in km^2", subtitle = "Histogram of NMFS area size in km^2.\nArea of one 200km size cell in red, Area of one cell and six neighbors in blue.")
```

```{r Box 8}
# Define temporal extent as -2 to +2 weeks and spatial extent as 200km hex cell and neighboring cells within 200km. 
# Counting the number of unique trips per post-stratum.
box_8_dt <- unique(
  val_2018_2021_dt[
  ][, .(ADP, STRATA, TRIP_ID, ADFG_STAT_AREA_CODE, WEEK)
  ][ADFG_STAT_AREA_CODE == 515832, ADFG_STAT_AREA_CODE := 515831])

# Merge the hex cells by ADFG_STAT_AREA_CODE, then drop ADFG_STAT_AREA_CODE to get unique HEX_ID for each trip
box_8_dt <- unique(data.table(stat_area_200km_lst$STAT_AREA_HEX_DF)[
][box_8_dt, on = .(ADFG_STAT_AREA_CODE)
][, -"ADFG_STAT_AREA_CODE"])

# Now search for neighbors using the overlapping temporal and spatial extents
box_8_lst <- lapply(
  
  # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
  X = lapply(
    X = split(
      x = unique(box_8_dt[, .(ADP, STRATA, HEX_ID, WEEK, TRIP_ID)]), 
      by = c("ADP", "STRATA"), keep.by = F), 
    FUN = as.matrix),
  # Identify post-strata and search for overlapping TRIP_IDs
  FUN = function(x) {
    # Get unique post-strata (WEEK)
    x0 <- unique(x[, 1:2, drop = F])       # Columns: [1:HEX_ID], [2:WEEK]
    # For each post-stratum, find all trips with overlapping post-stratum components
    apply(
      X = x0, MARGIN = 1,                            
      FUN = function(y)  {
        # Identify trips in each post-stratum: Match NMFS_AREA and search for WEEK with -2 to +2 search range
        # Then count number of unique TRIP_ID (third column)
        length(unique(x[(x[,1] %in% stat_area_200km_dist_rad_200_lst[[ y[1] ]]) & (x[,2] %in% (y[2] + -2:2)),, drop = F][, 3])) 
      }
    )
  }
)

# Determine total number of post-strata and proportion of post-strata with only one trip.
box_8_prop_1_dt <- cbind(
  # Split names to create ADP and STRATA columns
  rbindlist(lapply(
    X = strsplit(names(sapply(box_8_lst, function(x) round(sum(x==1) / length(x), 4))), split = "[.]"), 
    FUN = function(x) data.table(ADP = x[1], STRATA = x[2]))),
  # Calculate proportion of post-strata with only 1 trip
  NUM_OF_PS = lengths(box_8_lst),
  PROP_1 = unname(sapply(box_8_lst, function(x) round(sum(x==1) / length(x), 4)))    
)[, ADP := as.integer(ADP)][]

# Table of proportion of post-strata with only 1 trip
flextable(dcast(box_8_prop_1_dt[STRATA != "ZERO"], ADP ~ STRATA, value.var = "PROP_1")) %>% 
  colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[200km Hex] + [5 week overlapping] : Proportion of post-strata with only 1 trip.")

# Comparison of PROP_1 between 250km hex cell and 250km hex cell
ggplot(
  data = rbind(
    cbind(box_6_prop_1_dt, Box = "[250km Hex] + [5 week overlapping]"),
    cbind(box_8_prop_1_dt, Box = "[200km Hex] + [5 week overlapping]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[250km Hex] + [5 week overlapping]", "[200km Hex] + [5 week overlapping]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~STRATA) + 
  theme(legend.position="bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")

```

The results between 250km and 200km are very similar. With smaller cells you get a greater number of post-strata you can generally expect fewer trips in each post-stratum and less overlap. There are even a few instances where these smaller cells result in fewer 1-trip cells (e.g., EM_HAL 2019, HAL 2020). These results might suggest that above 200km there isn't much to be gained in terms of sparsely populated post-strata.

Let's also throw trip target back in to see what kind of effect is has with the overlapping temporal and spatial extents for post-strata:

### (9) Target Returns : [200km Hex Cell] + [5 week overlapping] + [Target]

```{r Box 9}

# Define temporal extent as -2 to +2 weeks and spatial extent as 200km hex cell and neighboring cells within 125km. 
# Counting the number of unique trips per post-stratum.
box_9_dt <- unique(
  val_2018_2021_dt[
  ][, .(ADP, STRATA, TRIP_ID, ADFG_STAT_AREA_CODE, WEEK, TARGET)
  ][ADFG_STAT_AREA_CODE == 515832, ADFG_STAT_AREA_CODE := 515831])

# Merge the hex cells by ADFG_STAT_AREA_CODE, then drop ADFG_STAT_AREA_CODE to get unique HEX_ID for each trip
box_9_dt <- unique(
  data.table(stat_area_200km_lst$STAT_AREA_HEX_DF)[
  ][box_9_dt, on = .(ADFG_STAT_AREA_CODE)
  ][, -"ADFG_STAT_AREA_CODE"])

# Get count of post-strata by target
box_9_target_counts_dt <- box_9_dt[, .(POSTRATA_COUNT_WITH_TARGET = .N), keyby=.(ADP, STRATA, TARGET)]

# Target is currently a character value. Convert it to an integer.
box_9_dt[, TARGET := .GRP, by = TARGET][, TARGET := as.integer(TARGET)]

# Now search for neighbors using the overlapping temporal and spatial extents
box_9_lst <- lapply(
  
  # Initialize dataset columns. Split by non-overlapping post-stratum components, and then convert to matrix class
  X = lapply(
    X = split(
      x = unique(box_9_dt[, .(ADP, STRATA, HEX_ID, WEEK, TARGET, TRIP_ID)]), 
      by = c("ADP", "STRATA"), keep.by = F), 
    FUN = as.matrix),
  # Identify post-strata and search for overlapping TRIP_IDs
  FUN = function(x) {
    # Get unique post-strata (WEEK)
    x0 <- unique(x[, 1:3, drop = F])       # Columns: [1:HEX_ID], [2:WEEK], [3:TARGET]
    # For each post-stratum, find all trips with overlapping post-stratum components
    apply(
      X = x0, MARGIN = 1,                            
      FUN = function(y)  {
        # Identify trips in each post-stratum: Match NMFS_AREA and search for WEEK with -2 to +2 search range
        # Then count number of unique TRIP_ID (third column)
        length(unique(x[
          (x[,1] %in% stat_area_200km_dist_rad_200_lst[[ y[1] ]]) & 
          (x[,2] %in% (y[2] + -2:2) & 
          (x[,3] == y[3])), , 
          drop = F][, 4])) 
      }
    )
  }
) # 0.56 sec

# Determine total number of post-strata and proportion of post-strata with only one trip.
box_9_prop_1_dt <- cbind(
  # Split names to create ADP and STRATA columns
  rbindlist(lapply(
    X = strsplit(names(sapply(box_9_lst, function(x) round(sum(x==1) / length(x), 4))), split = "[.]"), 
    FUN = function(x) data.table(ADP = x[1], STRATA = x[2]))),
  # Calculate proportion of post-strata with only 1 trip
  NUM_OF_PS = lengths(box_9_lst),
  PROP_1 = unname(sapply(box_9_lst, function(x) round(sum(x==1) / length(x), 4)))    
)[, ADP := as.integer(ADP)][]

# Table of proportion of post-strata with only 1 trip
flextable(dcast(box_9_prop_1_dt[STRATA != "ZERO"], ADP ~ STRATA, value.var = "PROP_1")) %>% 
  colformat_int(j = 1, big.mark = "")  %>% 
  set_caption(caption = "[200km Hex] + [5 week overlapping] + [Target] : Proportion of post-strata with only 1 trip.")

# Comparison of PROP_1 between 250km hex cell and 250km hex cell
ggplot(
  data = rbind(
    cbind(box_8_prop_1_dt, Box = "[200km Hex] + [5 week overlapping]"),
    cbind(box_9_prop_1_dt, Box = "[200km Hex] + [5 week overlapping] + [Target]")
  )[STRATA != "ZERO"][, Box := factor(Box, levels = c("[200km Hex] + [5 week overlapping]", "[200km Hex] + [5 week overlapping] + [Target]"))],
  aes(fill = Box, x = ADP, y = PROP_1, label = NUM_OF_PS)
) + geom_col(position = "dodge") + geom_text(size=3, position = position_dodge2(width = 1), hjust = 0.5) + 
  facet_wrap(~ STRATA) + 
  theme(legend.position = "bottom", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = "Year", y = "Proportion of post-strata with only 1 trip", subtitle = "Annotions represent total number of post-strata")

```

Adding trip target has a greater effect on trawl gear strata than on fixed gear strata. This is likely because we have effectively prevented NPT and PTR trips from overlapping.

```{r post-strata of a particular target}

# Count number of post-strata with a particular TARGET
flextable(dcast(box_9_target_counts_dt[STRATA != "ZERO"], STRATA + ADP ~ TARGET, value.var = "POSTRATA_COUNT_WITH_TARGET")) %>% 
  hline(i = 4*(1:6)) %>% 
  colformat_int(j = 2, big.mark = "") %>%
  set_caption(caption = "Number of post-strata with a particular target, 5-week overlap and 200km hex") %>%
  padding(padding = 0, part = "all") %>%
  fontsize(size = 9, part = "all") %>% 
  autofit()
```

Note that in more recent years, TRW has vastly fewer post-strata with targets of H, L, and W, which should explain the discrepancies in the number of 1-trip post-strata in 2018+2019 versus 2020+2021.

### Distributions of counts of trips within post-strata

At this point we've been focusing on the number of 1-trip post-strata, but as we've broadened our post-strata definitions, we have fewer sparsely populated post-strata. Let's instead focus on how many trips we have in post-strata. We'll start from (6) onward.

Below is plot showing the density of post-stratum trip counts within each box definition.

```{r post strata trip count distributions}
box_6_counts_dt <- rbindlist(
  lapply(box_6_lst, function(x) data.table(PS_N = length(x), N = x) ), idcol = "ADP.STRATA"
)[, c("ADP", "STRATA") := tstrsplit(ADP.STRATA, split = "[.]" )
][, ADP.STRATA := NULL][, Box := "[250km] + [5week]"][]

box_7_counts_dt <- rbindlist(
  lapply(box_7_lst, function(x) data.table(PS_N = length(x), N = x) ), idcol = "ADP.STRATA"
)[, c("ADP", "STRATA") := tstrsplit(ADP.STRATA, split = "[.]" )
][, ADP.STRATA := NULL][, Box := "[125km] + [5week]"][]

box_8_counts_dt <- rbindlist(
  lapply(box_8_lst, function(x) data.table(PS_N = length(x), N = x) ), idcol = "ADP.STRATA"
)[, c("ADP", "STRATA") := tstrsplit(ADP.STRATA, split = "[.]" )
][, ADP.STRATA := NULL][, Box := "[200km] + [5week]"][]

box_9_counts_dt <- rbindlist(
  lapply(box_9_lst, function(x) data.table(PS_N = length(x), N = x) ), idcol = "ADP.STRATA"
)[, c("ADP", "STRATA") := tstrsplit(ADP.STRATA, split = "[.]" )
][, ADP.STRATA := NULL][, Box := "[200km] + [5week] + [Target]"][]

box_counts_dt <- rbind(box_6_counts_dt, box_7_counts_dt, box_8_counts_dt, box_9_counts_dt)[STRATA != "ZERO"]

ggplot(box_counts_dt, aes(x = N, color = Box)) +
  facet_grid(STRATA ~ ADP, scales = "free") + 
  geom_density(alpha = 0.5, size = 1) + 
  coord_cartesian(xlim = c(0, 50)) + theme(legend.position = "bottom") 
```

Below is a violin plot of the distributions of the number of trips in post-strata, means as blue dots.

```{r boxplots, fig.width = 6, fig.height = 10, warning = F}
ggplot(box_counts_dt, aes(x = Box, y = N)) +
  facet_grid(STRATA ~ ADP, scales = "free", space = "free") + 
  geom_violin(alpha = 0.5, size = .05, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  stat_summary(geom = "point", color = "blue", fun = mean) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) + 
  labs(x = "Box definition", y = "Number of trips per post-stratum", subtitle = "Blue dots represent mean")
```

Finally, in tabular form, the 10%, 25%, 50%, 75%, and 90% quantiles.

```{r table of quantiles}

box_counts_quantiles_dt <- box_counts_dt[, as.list(quantile(
  N, probs = c(0.1, 0.25, 0.5, 0.75, 0.9))), 
  keyby = .(STRATA, Box, ADP)] 
box_counts_quantiles_dt %>%
  flextable() %>%
  padding(padding = 0, part = "all") %>%
  hline(i = 4*(1:24)) %>%
  fontsize(size = 9) %>%
  autofit()
```
