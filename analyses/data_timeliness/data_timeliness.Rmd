---
title: "Data Timeliness Evaluation Metric"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

```{r start, include=FALSE}
library(reshape2)
library(ROracle)
library(tidyverse)

channel_akro <- eval(parse(text = Sys.getenv("channel_cas")))
channel_afsc <- eval(parse(text = Sys.getenv("channel_afsc")))

knitr::opts_chunk$set(echo = FALSE)
options(scipen = 9999)
```

```{r get_data}
em_trip_end <- dbGetQuery(channel_afsc, "
select distinct e.odds_trip_number, t.trip_number, 
decode(e.gear_type, 'LONGLINE', 'EM HAL', 'POT', 'EM POT') as strata,
t.trip_end_date_time as trip_end
from norpac.odds_logged_trip_summary_v e
join norpac.odds_em_request_status h on h.status_year = e.year 
join norpac.odds_monitor i on i.trip_plan_log_seq = e.odds_trip_number
left join em_pac_review.em_trip t on t.trip_plan_log_seq = e.odds_trip_number
where e.year = 2022
and e.observer_status_code <> 'NO'
and e.trip_status in ('COMPLETED', 'PENDING')
and i.sample_plan_seq in (13)
order by t.trip_number")

em_data_available <- dbGetQuery(channel_akro, "
select h.ORIGINAL_EM_TRIP_NUMBER as trip_number, trunc(min(r.EFFECTIVE_DATE)) data_available
from AKFISH_REPORT.CATCH_REPORT_SOURCE r
join AKFISH_REPORT.CATCH_REPORT_SPECIES_FACT f on r.CATCH_REPORT_SOURCE_PK = f.CATCH_REPORT_SOURCE_PK
join AKFISH_REPORT.EM_HAUL h on f.EM_HAUL_PK = h.EM_HAUL_PK
join AKFISH_REPORT.CALENDAR_DATE c on f.REPORT_DATE_PK = c.CALENDAR_DATE_PK
where r.year_pk >= 2021 
and r.CATCH_REPORT_TYPE_CODE = 'EM'
group by h.ORIGINAL_EM_TRIP_NUMBER
order by h.ORIGINAL_EM_TRIP_NUMBER")

ob_trips <- dbGetQuery(channel_afsc, 
  "select t.cruise, t.permit, t.trip_seq, t.end_date as trip_end
   from norpac.atl_fma_trip t
   join norpac.ols_observer_cruise cru on cru.cruise = t.cruise
   join norpac.ols_observer_contract con on con.contract_number = cru.contract_number
   where extract(year from t.start_date) = 2022
   and con.employer_code = 'AIS'
   and t.did_fishing_occur_flag = 'Y'")

ob_hauls <- dbGetQuery(channel_afsc, 
  "select h.seq_number, h.cruise, h.permit, h.trip_seq, h.haul_seq, 
   decode(g.description, 'Pelagic Trawl', 'TRW', 'Non Pelagic Trawl', 'TRW', 'Pot or Trap', 'POT', 'Longliner', 'HAL') strata, 
   min(h.date_changed) as data_in
   from norpac.atl_haul_h h
   join norpac.atl_lov_gear_type g on g.gear_type_code = h.gear_type_code and g.geartype_form = h.geartype_form
   join norpac.ols_observer_cruise cru on cru.cruise = h.cruise
   join norpac.ols_observer_contract con on con.contract_number = cru.contract_number
   where extract(year from deploy_date_time) = 2022
   and con.employer_code = 'AIS'
   group by h.seq_number, h.cruise, h.permit, h.trip_seq, h.haul_seq, 
   decode(g.description, 'Pelagic Trawl', 'TRW', 'Non Pelagic Trawl', 'TRW', 'Pot or Trap', 'POT', 'Longliner', 'HAL')")
```

```{r wrangle_data}
em_data_timeliness <- em_trip_end %>% 
                      left_join(
                      em_data_available, 
                      by = "TRIP_NUMBER"
                      ) %>% 
                      # TODO: decide how to handle trips that weren't reviewed
                      filter(!is.na(TRIP_NUMBER)) %>% 
                      select(-ODDS_TRIP_NUMBER) %>% 
                      mutate(TRIP_END = as.Date(TRIP_END),
                             DATA_AVAILABLE = as.Date(DATA_AVAILABLE),
                             time_to_availability = as.numeric(DATA_AVAILABLE - TRIP_END))

ob_data_timeliness <- ob_trips %>% 
                      inner_join(
                      ob_hauls %>% 
                      group_by(CRUISE, PERMIT, TRIP_SEQ, STRATA) %>% 
                      summarise(DATA_IN = min(DATA_IN[HAUL_SEQ == max(HAUL_SEQ)]), .groups = "drop"),
                      by = c("CRUISE", "PERMIT", "TRIP_SEQ")
                      ) %>% 
                      mutate(TRIP_NUMBER = paste0(CRUISE, PERMIT, TRIP_SEQ), 
                             TRIP_END = as.Date(TRIP_END),
                             # TODO: use AKRO query to make this equivalent to EM (data available day after AFSC)
                             DATA_AVAILABLE = as.Date(DATA_IN)) %>% 
                      select(TRIP_NUMBER, STRATA, TRIP_END, DATA_AVAILABLE) %>%  
                      mutate(time_to_availability = as.numeric(DATA_AVAILABLE - TRIP_END))

data_timeliness <- rbind(em_data_timeliness, ob_data_timeliness)
```

```{r figure}
times_smry <- data_timeliness %>%
              group_by(STRATA) %>%
              summarise('25th percentile' = round(as.vector(quantile(time_to_availability, 0.25))),
                        median = round(as.vector(quantile(time_to_availability, 0.50))),
                        '75th percentile' = round(as.vector(quantile(time_to_availability, 0.75))),
                        mean = round(mean(time_to_availability)), .groups = "drop") %>%
              melt(id.vars=c("STRATA"), measure.vars=c("25th percentile", "median", "75th percentile", "mean")) %>%
              mutate(label = formatC(value, width=max(nchar(value))))

times_figure <- ggplot(data_timeliness, aes(x=time_to_availability)) +
                facet_grid(STRATA ~ ., scales="free_y") +
                geom_histogram(bins=20, fill="gray70") +
                geom_vline(data=filter(times_smry, variable == "median"), aes(xintercept=value), linetype=2) +
                geom_text(data=filter(times_smry, variable == "median"), aes(x=value, y=Inf, label=paste(label, "days")), angle=90, hjust=1.1, vjust=-.25, size=8) +
                labs(x="Days", y="Count") +
                theme_bw() +
                theme(text=element_text(size=26))

ggsave(filename = "output_figures/data_timeliness.png", width = 16, height = 9, units = 'in')
```

