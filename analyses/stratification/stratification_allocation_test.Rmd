---
title: "Preliminary Rates"
author: "Geoff_Mayhew"
date: "2023-06-15"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(data.table)
library(ggplot2)
library(magrittr)  # for piping
library(flextable)
library(grid)
library(gridExtra)

```


```{r load data, include = F}
load("rates_lst.rdata")      # https://drive.google.com/file/d/1DnkWWMCCM9L97ccHXWTjVpB3iJ8NHzxa/view?usp=drive_link
load("dmn_insp_list.rdata")  # https://drive.google.com/file/d/1fEr4dwzRNFqEEl67cvYfKVbXJZonsaEQ/view?usp=drive_link
# This function is old and was used for the tables - replaced by STRATUM_COL now?
replace_hyphen <- function(x){
  # x <- rates_lst$MPO$bsai_goa
  x1 <- copy(x)
  x1[, STRATA := gsub("[-]", "*", STRATA)]  
  x1
}

max_rate <- max(unlist(sapply(rates_lst, "[[", "RATE")))

plot_formats <- list(
  labs(y = "Stratum", x = "Selection Rate"),
  scale_y_discrete(limits = rev),
  scale_fill_manual(values = c("dodgerblue", "dodgerblue4", "chartreuse3")),
  theme(legend.position = "none", axis.text.y = element_text(hjust = 0)),
  scale_x_continuous(limits = c(0, max_rate), breaks = seq(0, 1, by = 0.05)) 
)

# Make all the plots
plot_lst <- lapply(
  rates_lst,
  function(x) ggplot(x[, .(ADP, STRATUM_COL, RATE, FILL)], aes(x = RATE, y = STRATUM_COL)) + 
  facet_grid(ADP ~ .) + geom_col(aes(fill = FILL)) + 
  plot_formats
)

# Add the trip counts to each plot
trip_counts <- lapply(trip_counts, function(x) x[order(ADP, STRATUM_COL)][!STRATUM_COL %like% "ZERO"])
for(i in 1:length(plot_lst)) {
  strat_name <- unlist(strsplit(split = "[.]", names(plot_lst)[[i]]))[1]
  if(strat_name == "EQUAL") strat_name <- "CURRENT"
  plot_lst[[i]] <- plot_lst[[i]] + 
    geom_text(data = trip_counts[[strat_name]], aes(label = N, x = max_rate), size = 2.5, hjust = 1)
}

# Make all plots have the same widths
grob_lst <- lapply(plot_lst, ggplotGrob)
widths_lst <- lapply(grob_lst, function(x) x[["widths"]])
plot_widths <- do.call(unit.pmax, widths_lst)
for(i in 1:length(grob_lst)) grob_lst[[i]]$widths <- plot_widths
# to call the plot, use the syntax:   grid.arrange(grob_lst$EQUAL.EQUAL)

```


# Preliminary rates with a $4.5M budget  

- '*FMP*' means strata were additionally stratified by BSAI and GOA (by majority of retained catch). Separating the BS from the AI results in strata that are too small and was not evaluated here.
- '*Fixed*' means all HAL and POT gear trips in the pools (monitoring method) were combined into fixed-gear stratum.
- '*Mixed*' means we would have a separate stratum for trips fishing both HAL and POT gear, separate from trips that fish solely with HAL or POT gear. 
- '*(SQ)* refers to the status-quo application of the minimum+optimized allocation method where the EM strata are allocated at 30% or 1/3 using a carve-off of funds from the total monitoring budget. This is in contrast with the general application, *MPO*, that applies the allocatino algorithm to all strata. 
- *(MPO 50)* is the older version of the status quo method that did not applies a 50% confidence level of achieving the 15% minimum (compared to the current 95% confidence level). 
- '*(GS)*', or *gear-specific*, means that interspersion was calculated in a gear-specific manner (applies to *Fixed* stratification schemes only), such that only trips with the same gear type were allowed to neighbor (contrasted with allowing POT and HAL trips in the same fixed-gear stratum to neighbor).

Notes:
 
- Monitoring-method-specific per day costs were assumed from the 2023 ADP and no assumptions were made about economy of scale, including the 2,000 day manimum of the current partial coverage observer contract. Those per-day costs were:
  + At-sea observer: $1,582.62
  + At-sea fixed-gear EM: $563.38
  + Shoreside observer: $600.00
- Within the proximity method, the CV-scaling portion of the index was left as-is for the *Fixed* stratification - that is, the total number of HAL and/or POT trips was used and not calculated in a gear-specific manner.


# Sample rates with allocations nested within stratifications {.tabset .tabset-pills}

Select a stratification scheme and then an allocation scheme. The equal rates allocation scheme was only applied to the 'Current' stratification scheme. Note that the tabs remember which allocation scheme is selected within each stratification, so you can also compare how the same allocation method responds to changes in stratification.

## Current {.tabset .tabset-pills}

### Equal Rates
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$EQUAL.EQUAL)
```

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$CURRENT.MPO_SQ)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$CURRENT.MPO)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$CURRENT.CWB)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$CURRENT.PROX)
```


## FMP {.tabset .tabset-pills}


### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FMP.MPO_SQ_FMP)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FMP.MPO_FMP)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FMP.CWB_FMP)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FMP.PROX_FMP)
```


## Fixed {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.MPO_SQ_FIXED)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.MPO_FIXED)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.CWB_FIXED)
```

### CWB (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.CWB_FIXED_GS)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.PROX_FIXED)
```

### PROX (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED.PROX_FIXED_GS)
```

## Fixed FMP {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.MPO_SQ_FIXED_FMP)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.MPO_FIXED_FMP)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.CWB_FIXED_FMP)
```

### CWB (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.CWB_FIXED_FMP_GS)

```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.PROX_FIXED_FMP)
```

### PROX (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$FIXED_FMP.PROX_FIXED_FMP_GS)

```

## Mixed {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$MIXED.MPO_SQ_MIXED)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$MIXED.MPO_MIXED)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$MIXED.CWB_MIXED)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(grob_lst$MIXED.PROX_MIXED)
```



# Tabular form (In-progress) {.tabset .tabset-pills}

## Equal

Applying equal rates to all strata. This was not repeated for all of our stratification variants.

```{r equal, eval = F}
rates_lst$EQUAL.EQUAL %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:9), digits = 2) %>% colformat_double(j = c(7), digits = 4) %>%
  hline(i = 6 * (1:4)) %>% bold(j = c(1:2, 7))
```

## Min+Opt (status quo) {.tabset .tabset-pills}

Applying the minimum + optimum allocation scheme to HAL, POT, and TRW strata only, carving off funds each year to achieve a 30% fixed-gear EM monitoring rate and a 1/3 shoreside sampling rate for EM_TRW. A 95% confidence level of achieving the 15% minimum was initially set. '*CONF*' is either blank (reverted to equal rates), equal to 0.95 (achieved), or between 0 and 0.95 (the highest confidence level afforded). If the confidence level was achieved, the number of 'optimized trips' ('*OPT_N*') are given.

### Current
```{r mpo_sq_current, eval = F}
rates_lst$CURRENT.MPO_SQ %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 6 * (1:4)) %>% bold(j = c(1:2, 7))
```

### BSAI_GOA
```{r mpo_sq_bsai_goa, eval = F}
rates_lst$FMP.MPO_SQ_FMP %>% replace_hyphen() %>%
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 11 * (1:4)) %>% bold(j = c(1:2, 7))
```

### Fixed
```{r mpo_sq_fixed, eval = F}
rates_lst$FIXED.MPO_SQ_FIXED %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 4 * (1:4)) %>% bold(j = c(1:2, 7))
```

### Fixed + BSAI_GOA
```{r mpo_sq_fixed_bsai_goa, eval = F}
rates_lst$FIXED_FMP.MPO_SQ_FIXED_FMP %>% replace_hyphen() %>%
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 7 * (1:4)) %>% bold(j = c(1:2, 7))
```

## Min+Opt (for all strata) {.tabset .tabset-pills}

Applying the minimum + optimum allocation scheme to all strata (including fixed-gear EM and trawl EM). Again, a 95% confidence level of achieving the 15% minimum was initially set. '*CONF*' is either blank (reverted to equal rates), equal to 0.95 (achieved), or between 0 and 0.95 (the highest confidence level afforded)

### Current
```{r mpo_current, eval = F}
rates_lst$CURRENT.MPO %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 6 * (1:4)) %>% bold(j = c(1:2, 7))
```

### BSAI_GOA
```{r mpo_bsai_goa, eval = F}
rates_lst$FMP.MPO_FMP %>% replace_hyphen() %>%
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 11 * (1:4))
```

### Fixed
```{r mpo_fixed, eval = F}
rates_lst$FIXED.MPO_FIXED %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 4 * (1:4))
```

### Fixed + BSAI_GOA
```{r mpo_fixed_bsai_goa, eval = F}
rates_lst$FIXED_FMP.MPO_FIXED_FMP %>% replace_hyphen() %>%
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(4:6, 8:10), digits = 2) %>% colformat_double(j = c(7, 11:13), digits = 4) %>%
  hline(i = 7 * (1:4))
```

## Cost-Weighted Boxes {.tabset .tabset-pills}

'*fh*' is the selection rate allocated. 
'*SAMPLE_RATE*' is the sample rate that is assumed beforehand to determine *Ph* (the proportion of boxes expected to NOT to be neighboring a sampled trip), and should be very close to *fh*.

### Current
```{r cwb_current, eval = F}
rates_lst$CURRENT.CWB %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 2, big.mark = "") %>% colformat_double(j = c(6:10), digits = 2) %>%  colformat_double(j = c(1, 4, 11), digits = 4) %>% 
  hline(i = 6 * (1:4)) %>% bold(j = c(2:3, 11))
```

### BSAI_GOA
```{r cwb_bsai_goa, eval = F}
rates_lst$FMP.CWB_FMP %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 2, big.mark = "") %>% colformat_double(j = c(7:11), digits = 2) %>%  colformat_double(j = c(1, 5, 12), digits = 4) %>% 
  hline(i = 11 * (1:4)) %>% bold(j = c(2:4, 12))
```

### Fixed
```{r cwb_fixed, eval = F}
rates_lst$FIXED.CWB_FIXED %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 2, big.mark = "") %>% colformat_double(j = c(6:10), digits = 2) %>%  colformat_double(j = c(1, 4, 11), digits = 4) %>% 
  hline(i = 4 * (1:4)) %>% bold(j = c(2:3, 11))
```

### Fixed + BSAI_GOA
```{r cwb_fixed_bsai_goa, eval = F}
rates_lst$FIXED_FMP.CWB_FIXED_FMP %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 2, big.mark = "") %>% colformat_double(j = c(7:11), digits = 2) %>%  colformat_double(j = c(1, 5, 12), digits = 4) %>% 
  hline(i = 7 * (1:4))  %>% bold(j = c(2:4, 12))
```

## Proximity  {.tabset .tabset-pills}

'*ISPN*' is the proportino of trips in the stratum neighboring a monitored trip (*sum_pw* / *STRATA_N*).
'*sum_pw*' is the expected number of trips in the stratum neighboring a monitored trip.
'*INDEX*' = *ISPN* / *CV_SCALING* (not always exact, bust the closest within a 0.0001 change in monitoring rate).

### Current
```{r prox_current, eval = F, eval = F}
rates_lst$CURRENT.PROX %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(6:7, 11), digits = 2) %>%  colformat_double(j = c(3:4, 8:10), digits = 4) %>% 
  hline(i = 6 * (1:4)) %>% bold(j = c(1:3))
```

### BSAI_GOA
```{r prox_bsai_goa, eval = F}
rates_lst$FMP.PROX_FMP %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(7:8, 12), digits = 2) %>%  colformat_double(j = c(5:6, 9:11), digits = 4) %>% 
  hline(i = 11 * (1:4)) %>% bold(j = c(1:4))
```

### Fixed
```{r prox_fixed, eval = F}
rates_lst$FIXED.PROX_FIXED %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(6:7, 11), digits = 2) %>%  colformat_double(j = c(3:4, 8:10), digits = 4) %>% 
  hline(i = 4 * (1:4)) %>% bold(j = c(1:3))
```

### Fixed (gear-specific)
```{r prox_fixed_gs, eval = F}
rates_lst$FIXED.PROX_FIXED_GS %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(6:7, 11), digits = 2) %>%  colformat_double(j = c(3:4, 8:10), digits = 4) %>% 
  hline(i = 4 * (1:4)) %>% bold(j = c(1:3))
```

### Fixed + BSAI_GOA

```{r prox_fixed_bsai_goa, eval = F}
rates_lst$FIXED_FMP.PROX_FIXED_FMP %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(7:8, 12), digits = 2) %>%  colformat_double(j = c(5:6, 9:11), digits = 4) %>% 
  hline(i = 7 * (1:4)) %>% bold(j =c(1:4))
```

### Fixed + BSAI_GOA (gear-specific)

```{r prox_fixed_bsai_goa_gs, eval = F}
rates_lst$FIXED_FMP.PROX_FIXED_FMP_GS %>% 
  flextable() %>% padding(padding = 1) %>% autofit()  %>% fontsize(size = 8, part = "all") %>% 
  colformat_int(j = 1, big.mark = "") %>% colformat_double(j = c(7:8, 12), digits = 2) %>%  colformat_double(j = c(5:6, 9:11), digits = 4) %>% 
  hline(i = 7 * (1:4)) %>% bold(j = c(1:4))
```

# Still in progress

- Running these rates through the domain interspersion evaluation (deterministic version). 


# Domain Interspersion  {.tabset .tabset-pills}

Domain interspersion is the expected proportion of trips neighboring a monitored trip. We summarize this at the monitoring method level (i.e., Fixed-Gear EM, Trawl EM, Observer, or Zero) and by gear type (HAL, POT, and TRW), together defined as a domain. We can calculate domain interspersion in ak AK-wide manner (top panel) or by separating the BSAI from the GOA (bottom panel).

The bars represent the domain interspersion when compared to neighboring Observed trips:

- Observed fixed gear trips to other observer pool trips, fixed-gear EM pool trips, and ZERO pool trips
- Observed Trawl trips to other observer pool trawl trips
- Trawl EM trips to other shores to other Trawl EM trips

The yellow diamonds represent the domain interspersion of fixed-gear EM trips to other fixed-gear EM trips.

## Current  {.tabset .tabset-pills}

### Equal Rates
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$EQUAL.EQUAL)
```

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$CURRENT.MPO_SQ)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$CURRENT.MPO)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$CURRENT.CWB)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$CURRENT.PROX)
```


## FMP {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FMP.MPO_SQ_FMP)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FMP.MPO_FMP)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FMP.CWB_FMP)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FMP.PROX_FMP)
```


## Fixed {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.MPO_SQ_FIXED)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.MPO_FIXED)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.CWB_FIXED)
```

### CWB (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.CWB_FIXED_GS)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.PROX_FIXED)
```

### PROX (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED.PROX_FIXED_GS)
```


## Fixed FMP {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.MPO_SQ_FIXED_FMP)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.MPO_FIXED_FMP)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.CWB_FIXED_FMP)
```

### CWB (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.CWB_FIXED_FMP_GS)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.PROX_FIXED_FMP)
```

### PROX (GS)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$FIXED_FMP.PROX_FIXED_FMP_GS)
```

## Mixed {.tabset .tabset-pills}

### MPO (SQ)
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$MIXED.MPO_SQ_MIXED)
```

### MPO
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$MIXED.MPO_MIXED)
```

### CWB
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$MIXED.CWB_MIXED)
```

### PROX
```{r echo=FALSE, fig.width = 8, fig.height = 6}
grid.arrange(figs_combined_grobs$MIXED.PROX_MIXED)
```


# Mixed X FMP Trip counts

The issue with crossing the MIXED stratification with the split of FMP by BSAI/GOA is that it results in strata with very small samples sizes or strata that don't have a history (both 'MIXED' and 'FMP' are splitting procedures, whereas 'FIXED' and 'FMP' are lumping and splitting procedures). The Min+Opt allocation scheme relies on having 3-years of fishing history, which for the EM_MIXED x BSAI stratum has a total of 11 trips, and the OB_MIXED x BSAI has 18 trips over the most recent 3 years.

```{r echo=FALSE, eval=FALSE}
dcast(trip_counts$MIXED_FMP, STRATA ~ BSAI_GOA + ADP, value.var = "N", sep = "\n") %>%
  flextable() %>% autofit() %>% padding(padding = 0.2, part = "all") %>%
  vline(j = seq(1, 11, 2)) 
```

# Summarize interspersion across monitoring methods

If we average interspersion values across gear types within a monitoring method, we can reduce the number of numbers to compare. Yes, we do lose some information. Below is an example for 2022 where we can compare the interspersion values achieved with a select bunch of stratifications and allocations. 

```{r fig.width=8, fig.height = 6}
dmn_insp_smry_lst <- lapply(
  dmn_insp_list,
  function(x) list(
    OVERALL = rbind(
      cbind(DONOR = "OB", copy(x$DMN_INSP_OB_SMRY$OVERALL)[
      ][, MM := fcase(POOL == "EM", fcase(GEAR == "TRW", "TRW_EM", GEAR %in% c("HAL", "POT"), "FG_EM"), POOL %in% c("OB", "ZERO"), POOL)
      ][, .(MEAN_INSP = mean(POOL_DMN_INTERSPERSION)), keyby = .(ADP, MM, POOL)]),
      cbind(DONOR = "EM", copy(x$DMN_INSP_NONOB_SMRY$OVERALL)[
      ][, MM := fcase(POOL == "EM", fcase(GEAR == "TRW", "TRW_EM", GEAR %in% c("HAL", "POT"), "FG_EM"), POOL %in% c("OB", "ZERO"), POOL)
      ][, .(MEAN_INSP = mean(POOL_DMN_INTERSPERSION)), keyby = .(ADP, MM, POOL)])
    ),
    BSAI_GOA = rbind(
      cbind(DONOR = "OB", copy(x$DMN_INSP_OB_SMRY$BSAI_GOA)[
      ][, MM := fcase(POOL == "EM", fcase(GEAR == "TRW", "TRW_EM", GEAR %in% c("HAL", "POT"), "FG_EM"), POOL %in% c("OB", "ZERO"), POOL)
      ][, .(MEAN_INSP = mean(POOL_DMN_INTERSPERSION)), keyby = .(ADP, MM, POOL, BSAI_GOA)]),
      cbind(DONOR = "EM", copy(x$DMN_INSP_NONOB_SMRY$BSAI_GOA)[
      ][, MM := fcase(POOL == "EM", fcase(GEAR == "TRW", "TRW_EM", GEAR %in% c("HAL", "POT"), "FG_EM"), POOL %in% c("OB", "ZERO"), POOL)
      ][, .(MEAN_INSP = mean(POOL_DMN_INTERSPERSION)), keyby = .(ADP, MM, POOL, BSAI_GOA)])
    )
  )
)

# Compare FIXED and FIXED_FMP and MIXED
fixed_mixed_overall <- rbind(
  cbind(STRAT = "FIXED",     ALLO = "CWB",  dmn_insp_smry_lst$FIXED.CWB_FIXED_GS$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB",  dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP_GS$OVERALL),
  cbind(STRAT = "MIXED",     ALLO = "CWB",  dmn_insp_smry_lst$MIXED.CWB_MIXED$OVERALL),
  cbind(STRAT = "FIXED",     ALLO = "PROX", dmn_insp_smry_lst$FIXED.PROX_FIXED_GS$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP_GS$OVERALL),
  cbind(STRAT = "MIXED",     ALLO = "PROX", dmn_insp_smry_lst$MIXED.PROX_MIXED$OVERALL)
)

# 2022 only
p1 <- ggplot(fixed_mixed_overall[ADP == 2022], aes(x = MM, y = MEAN_INSP, fill = STRAT)) + 
  facet_grid(ADP + ALLO ~ DONOR + POOL, scales = "free_x", space = "free_x", labeller = labeller(DONOR = function(x) paste0("DONOR: ", x), POOL = function(x) paste0("ACCEPTOR:", x))) + geom_col(position = "dodge") + geom_text(aes(y = MEAN_INSP + -0.1, label = round(MEAN_INSP, 4)), position = position_dodge(width = 1), size = 3) + theme(legend.position = "none", strip.text = element_text(margin = margin(0.2, 0.2, 0.2, 0.2))) + labs(x = "Monitoring Method", y = "Mean Interspersion")


fixed_mixed_fmp <- rbind(
  cbind(STRAT = "FIXED", ALLO = "CWB", dmn_insp_smry_lst$FIXED.CWB_FIXED_GS$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB", dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP_GS$BSAI_GOA),
  cbind(STRAT = "MIXED", ALLO = "CWB", dmn_insp_smry_lst$MIXED.CWB_MIXED$BSAI_GOA),
  
  cbind(STRAT = "FIXED", ALLO = "PROX", dmn_insp_smry_lst$FIXED.PROX_FIXED_GS$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP_GS$BSAI_GOA),
  cbind(STRAT = "MIXED", ALLO = "PROX", dmn_insp_smry_lst$MIXED.PROX_MIXED$BSAI_GOA)
)

# 2022 only
p2 <- ggplot(fixed_mixed_fmp[ADP == 2022], aes(x = interaction(MM, BSAI_GOA), y = MEAN_INSP, fill = STRAT)) + 
  facet_grid(ADP + ALLO ~ DONOR + POOL, scales = "free_x", space = "free_x", labeller = labeller(DONOR = function(x) paste0("DONOR: ", x), POOL = function(x) paste0("ACCEPTOR: ", x))) + geom_col(position = "dodge") + geom_text(aes(y = MEAN_INSP + -0.1, label = round(MEAN_INSP, 4)), position = position_dodge(width = 1), size = 3) + theme(legend.position = "bottom", strip.text = element_text(margin = margin(0.2, 0.2, 0.2, 0.2))) + labs(x = "Monitoring Method x FMP", y = "Mean Interspersion", fill = "Stratification")

p1_grob <- ggplotGrob(p1)
p2_grob <- ggplotGrob(p2)
p_widths <- unit.pmax(p1_grob$widths, p2_grob$widths)
p1_grob$widths <- p_widths
p2_grob$widths <- p_widths
p_combined <- arrangeGrob(p1_grob, p2_grob, ncol = 1, heights = c(0.45, 0.55))
grid.arrange(p_combined)
```

# Comparing gear-specific version of CWB and PROX

Note that the colors are different from the previous plot, and the facets were changed to help comparisons of the allocation schemes.

```{r, fig.width=8, fig.height=6}

# Compare FIXED and FIXED_FMP and MIXED
cwb_prox_gs_overall <- rbind(
  cbind(STRAT = "FIXED",     ALLO = "CWB",  dmn_insp_smry_lst$FIXED.CWB_FIXED$OVERALL),
  cbind(STRAT = "FIXED",     ALLO = "PROX", dmn_insp_smry_lst$FIXED.PROX_FIXED$OVERALL),
  cbind(STRAT = "FIXED",     ALLO = "CWB_GS",  dmn_insp_smry_lst$FIXED.CWB_FIXED_GS$OVERALL),
  cbind(STRAT = "FIXED",     ALLO = "PROX_GS", dmn_insp_smry_lst$FIXED.PROX_FIXED_GS$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB",  dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB_GS",  dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP_GS$OVERALL),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX_GS", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP_GS$OVERALL)
)

# 2022 only
p3 <- ggplot(cwb_prox_gs_overall[ADP == 2022], aes(x = MM, y = MEAN_INSP, fill = ALLO)) + 
  facet_grid(ADP + STRAT ~ DONOR + POOL, scales = "free_x", space = "free_x", labeller = labeller(DONOR = function(x) paste0("DONOR: ", x), POOL = function(x) paste0("ACCEPTOR:", x))) + geom_col(position = "dodge") + geom_text(aes(y = MEAN_INSP + -0.1, label = round(MEAN_INSP, 4)), position = position_dodge(width = 1), size = 3) + theme(legend.position = "none", strip.text = element_text(margin = margin(0.2, 0.2, 0.2, 0.2))) + labs(x = "Monitoring Method", y = "Mean Interspersion")

cwb_prox_gs_fmp <- rbind(
  cbind(STRAT = "FIXED", ALLO = "CWB", dmn_insp_smry_lst$FIXED.CWB_FIXED$BSAI_GOA),
  cbind(STRAT = "FIXED", ALLO = "PROX", dmn_insp_smry_lst$FIXED.PROX_FIXED$BSAI_GOA),
  cbind(STRAT = "FIXED", ALLO = "CWB_GS", dmn_insp_smry_lst$FIXED.CWB_FIXED_GS$BSAI_GOA),
  cbind(STRAT = "FIXED", ALLO = "PROX_GS", dmn_insp_smry_lst$FIXED.PROX_FIXED_GS$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB", dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "CWB_GS", dmn_insp_smry_lst$FIXED_FMP.CWB_FIXED_FMP_GS$BSAI_GOA),
  cbind(STRAT = "FIXED_FMP", ALLO = "PROX_GS", dmn_insp_smry_lst$FIXED_FMP.PROX_FIXED_FMP_GS$BSAI_GOA)
)
# 2022 only
p4 <- ggplot(cwb_prox_gs_fmp[ADP == 2022], aes(x = interaction(MM, BSAI_GOA), y = MEAN_INSP, fill = ALLO)) + 
  facet_grid(ADP + STRAT ~ DONOR + POOL, scales = "free_x", space = "free_x", labeller = labeller(DONOR = function(x) paste0("DONOR: ", x), POOL = function(x) paste0("ACCEPTOR: ", x))) + geom_col(position = "dodge") + geom_text(aes(y = MEAN_INSP + -0.1, label = round(MEAN_INSP, 4)), position = position_dodge(width = 1), size = 3) + theme(legend.position = "bottom", strip.text = element_text(margin = margin(0.2, 0.2, 0.2, 0.2))) + labs(x = "Monitoring Method x FMP", y = "Mean Interspersion", fill = "Allocation")

p3_grob <- ggplotGrob(p3)
p4_grob <- ggplotGrob(p4)
p_widths <- unit.pmax(p3_grob$widths, p4_grob$widths)
p3_grob$widths <- p_widths
p4_grob$widths <- p_widths
p34_combined <- arrangeGrob(p3_grob, p4_grob, ncol = 1, heights = c(0.45, 0.55))
grid.arrange(p34_combined)

```
